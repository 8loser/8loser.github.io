{
    "version": "https://jsonfeed.org/version/1",
    "title": "別在圍城時走散",
    "subtitle": "",
    "icon": "https://8loser.github.io/assets/favicon.ico",
    "description": "我在八樓閒晃",
    "home_page_url": "https://8loser.github.io",
    "items": [
        {
            "id": "https://8loser.github.io/2025/12/21/deploy-docker-nginx/",
            "url": "https://8loser.github.io/2025/12/21/deploy-docker-nginx/",
            "title": "多服務 Docker 部署與 Nginx 設定筆記",
            "date_published": "2025-12-21T00:58:03.000Z",
            "content_html": "<h1 id=\"文章說明\"><a class=\"anchor\" href=\"#文章說明\">#</a> 文章說明</h1>\n<p>這是將服務部署到雲端的專案。<br />\nVM 建立好後，將專案 pull 到  <code>/opt</code>  下即可快速部署。</p>\n<h1 id=\"環境\"><a class=\"anchor\" href=\"#環境\">#</a> 環境</h1>\n<p>每個服務程式碼由 GitHub 託管，並設置自動打包成 Docker image。<br />\n機器安裝 Docker，部署時 pull Docker image 啟動多個服務 container。<br />\n由 Nginx 控制請求進入服務。</p>\n<h1 id=\"專案資料夾結構\"><a class=\"anchor\" href=\"#專案資料夾結構\">#</a> 專案資料夾結構</h1>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"><span>資料夾結構</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>.</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>├── init.sh                # 機器初始化</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>├── prod</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>│   ├── docker-compose.yml # 正式站 Docker Swarm Stack 設定</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>│   └── nginx.conf         # 正式站 Nginx 設定</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>├── start-prod.sh          # 啟動</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>└── stop-prod.sh           # 停止</pre></td></tr></table></figure><p>首先執行  <code>init.sh</code>  更新系統、安裝常用程式，參考 <a href=\"/2023/01/04/gcp-init/\">GCP VM 建置筆記</a>。</p>\n<h1 id=\"start-prodsh\"><a class=\"anchor\" href=\"#start-prodsh\">#</a> <a href=\"http://start-prod.sh\">start-prod.sh</a></h1>\n<figure class=\"highlight sh\"><figcaption data-lang=\"sh\"><span>start-prod.sh</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token shebang important\">#!/bin/sh</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 啟動正式站 container</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">docker</span> stack deploy --compose-file prod/docker-compose.yml --with-registry-auth company</pre></td></tr></table></figure><p>這邊沒什麼好介紹的，就是用  <code>docker stack deploy</code>  啟動 Docker Swarm Stack。</p>\n<p><code>--with-registry-auth</code>  會把本機  <code>docker login</code>  的 registry 認證一併傳給 Swarm 節點，<br />\n讓節點在拉私有 image 時能順利通過授權；不加的話，私有倉庫常會出現拉不到 image 的錯誤。</p>\n<h1 id=\"docker-composeyml\"><a class=\"anchor\" href=\"#docker-composeyml\">#</a> docker-compose.yml</h1>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"><span>prod/docker-compose.yml</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 正式站 container</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3.8'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">nginx</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token comment\"># Nginx 設定檔</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token punctuation\">-</span> ./nginx.conf<span class=\"token punctuation\">:</span>/etc/nginx/conf.d/default.conf</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token key atrule\">TZ</span><span class=\"token punctuation\">:</span> Asia/Taipei</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">target</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token key atrule\">published</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token key atrule\">protocol</span><span class=\"token punctuation\">:</span> tcp</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token key atrule\">mode</span><span class=\"token punctuation\">:</span> host</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token comment\"># 後端 API</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token key atrule\">backend</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> ghcr.io/8loser/backend<span class=\"token punctuation\">:</span>main</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      <span class=\"token key atrule\">TZ</span><span class=\"token punctuation\">:</span> Asia/Taipei</pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token comment\"># 前端</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token key atrule\">frontend</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> ghcr.io/8loser/frontend<span class=\"token punctuation\">:</span>main</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      <span class=\"token key atrule\">TZ</span><span class=\"token punctuation\">:</span> Asia/Taipei</pre></td></tr></table></figure><p>說明：</p>\n<ul>\n<li>有 3 個服務；Nginx、frontend、backend。</li>\n<li>Nginx 不用  <code>depends_on backend, frontend</code>  避免某個服務異常導致 Nginx 被牽連停止。</li>\n<li>Nginx  <code>mode: host</code>  直接用主機 80 對外提供服務，Load Balancer 流量導入 Nginx 80 port，僅有跑該服務的節點會開 80。</li>\n<li>Nginx 設定檔直接掛載  <code>prod/nginx.conf</code>  檔案。</li>\n<li>Stack 會使用 Swarm overlay network， <code>proxy_pass http://frontend/</code>  與  <code>proxy_pass http://backend/</code>  會解析到同一個 Stack 的 service。</li>\n<li><code>ghcr.io</code>  是 GitHub Container Registry，用於存放 Docker image。</li>\n</ul>\n<h1 id=\"nginxconf\"><a class=\"anchor\" href=\"#nginxconf\">#</a> nginx.conf</h1>\n<figure class=\"highlight nginx\"><figcaption data-lang=\"nginx\"><span>prod/nginx.conf</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 正式站 Nginx</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 預設 server; 使用 IP 或未匹配的域名都會進入</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token directive\"><span class=\"token keyword\">server</span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token directive\"><span class=\"token keyword\">listen</span> <span class=\"token number\">80</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token directive\"><span class=\"token keyword\">server_name</span> _</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\"># 不合法 Host 訪問 /，不返回內容</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token directive\"><span class=\"token keyword\">location</span> /</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token directive\"><span class=\"token keyword\">return</span> <span class=\"token number\">204</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token directive\"><span class=\"token keyword\">server</span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token directive\"><span class=\"token keyword\">listen</span> <span class=\"token number\">80</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token comment\"># 允許的域名</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token directive\"><span class=\"token keyword\">server_name</span> www.*******.com *******.com</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token comment\"># Load Balancer Public IP address</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token directive\"><span class=\"token keyword\">set_real_ip_from</span> &lt;LB_IP>/32</span><span class=\"token punctuation\">;</span> <span class=\"token comment\"># 填入你的 LB IP</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token comment\"># Google CIDR 網段</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token directive\"><span class=\"token keyword\">set_real_ip_from</span> 130.211.0.0/22</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token directive\"><span class=\"token keyword\">set_real_ip_from</span> 35.191.0.0/16</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token directive\"><span class=\"token keyword\">real_ip_header</span> X-Forwarded-For</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token directive\"><span class=\"token keyword\">real_ip_recursive</span> <span class=\"token boolean\">on</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token comment\"># 阻擋的 User Agent</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token directive\"><span class=\"token keyword\">if</span> (<span class=\"token variable\">$http_user_agent</span> ~* <span class=\"token string\">\"ApacheBench|pingback|YisouSpider|MJ12bot|AhrefsBot|360JK|Jorgee|FeedDemon|BOT/0.1 (BOT for JCE)|CrawlDaddy|Java|Jullo|Feedly|UniversalFeedParser|Swiftbot|YandexBot|jikeSpider|ZmEu phpmyadmin|WinHttp|EasouSpider|HttpClient|Microsoft URL Control|YYSpider|jaunty|oBot|Python-urllib|Indy Library|FlightDeckReports Bot|Linguee Bot\"</span> )</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span>return <span class=\"token directive\"><span class=\"token keyword\">101</span></span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token comment\"># 正式站設定 robots.txt 允許爬蟲</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token directive\"><span class=\"token keyword\">location</span> = /robots.txt</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">add_header</span> Content-Type text/plain</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">return</span> <span class=\"token number\">200</span> <span class=\"token string\">\"User-agent: *<span class=\"token escape entity\">\\n</span>Allow: /<span class=\"token escape entity\">\\n</span>\"</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token comment\"># 前端</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token directive\"><span class=\"token keyword\">location</span> /</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">proxy_pass</span> http://frontend/</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> Host <span class=\"token variable\">$host</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> X-Real-IP <span class=\"token variable\">$remote_addr</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> X-Custom-Referrer smc_identity_layer</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  <span class=\"token comment\"># 後端</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  <span class=\"token directive\"><span class=\"token keyword\">location</span> /api/</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">proxy_pass</span> http://backend/</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> Host <span class=\"token variable\">$host</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> X-Real-IP <span class=\"token variable\">$remote_addr</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> X-Custom-Referrer smc_identity_layer</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>說明：</p>\n<ul>\n<li>預設 server 用於攔截未匹配的 Host，直接回 204。</li>\n<li><code>/</code>  走 frontend、 <code>/api/</code>  走 backend，使用  <code>proxy_pass</code>  轉發請求。</li>\n<li><code>set_real_ip_from</code>  用來限定可信任的轉發來源（LB 與 Google CIDR），才能正確還原 client IP，避免被偽造的  <code>X-Forwarded-For</code>  影響。</li>\n<li><code>proxy_pass http://backend/</code>  的  <code>backend</code>  對應  <code>docker-compose.yml</code>  的 service 名稱。</li>\n</ul>\n",
            "tags": [
                "Deploy",
                "Docker",
                "GCP",
                "Nginx",
                "log",
                "Deploy"
            ]
        },
        {
            "id": "https://8loser.github.io/2025/06/23/node-usb-relay/",
            "url": "https://8loser.github.io/2025/06/23/node-usb-relay/",
            "title": "Node.JS 控制 USB 繼電器",
            "date_published": "2025-06-23T06:36:42.000Z",
            "content_html": "<h1 id=\"usb-relay\"><a class=\"anchor\" href=\"#usb-relay\">#</a> USB Relay</h1>\n<p>USB relay 模組就是這個，預計用 Node.js 程式輸出電氣訊號控制機械手臂，這個是兩路的（兩個 relay），還有一路或者更多路的。</p>\n<p><img loading=\"lazy\" src=\"USB-relay.png\" alt=\"USB Relay\" /></p>\n<p>輸出接點跟一般繼電器的接點一樣</p>\n<table>\n<thead>\n<tr>\n<th>端點</th>\n<th>全名</th>\n<th>功能描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>COM</td>\n<td>Common（共用端）</td>\n<td>中心端點，根據控制情況與 NC 或 NO 接通</td>\n</tr>\n<tr>\n<td>NC</td>\n<td>Normally Closed（常閉）</td>\n<td>在  <code>未通電</code>  狀態下， <code>與 COM 接通</code></td>\n</tr>\n<tr>\n<td>NO</td>\n<td>Normally Open（常開）</td>\n<td>在  <code>未通電</code>  狀態下， <code>與 COM 斷開</code> ，通電後才接通</td>\n</tr>\n</tbody>\n</table>\n<p>接線方式使用 USB-A 轉 USB-B，USB-A 接電腦，USB-B 接模組</p>\n<p><img loading=\"lazy\" src=\"USB-A-to-USB-B.png\" alt=\"USB-A to USB-B\" /></p>\n<h1 id=\"程式測試\"><a class=\"anchor\" href=\"#程式測試\">#</a> 程式測試</h1>\n<p>使用 <a href=\"https://www.npmjs.com/package/node-hid\">node-hid</a> 套件，請先確定使用的模組支援 HID</p>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"><span>繼電器控制</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token constant\">HID</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'node-hid'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// 尋找連接裝置中 USBRelay 名稱的裝置</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">const</span> deviceList <span class=\"token operator\">=</span> <span class=\"token constant\">HID</span><span class=\"token punctuation\">.</span><span class=\"token function\">devices</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">const</span> connectedRelays <span class=\"token operator\">=</span> deviceList<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">device</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> device<span class=\"token punctuation\">.</span>product <span class=\"token operator\">&amp;&amp;</span> device<span class=\"token punctuation\">.</span>product<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'USBRelay'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">const</span> device <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HID<span class=\"token punctuation\">.</span>HID</span><span class=\"token punctuation\">(</span>connectedRelays<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">// 啟動第一個 relay</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>device<span class=\"token punctuation\">.</span><span class=\"token function\">sendFeatureReport</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xFF</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x01</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">// 啟動第二個 relay</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>device<span class=\"token punctuation\">.</span><span class=\"token function\">sendFeatureReport</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xFF</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x02</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">// 關閉第一個 relay</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>device<span class=\"token punctuation\">.</span><span class=\"token function\">sendFeatureReport</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xFD</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x01</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">// 關閉第二個 relay</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>device<span class=\"token punctuation\">.</span><span class=\"token function\">sendFeatureReport</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xFD</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x02</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>如果正常啟動繼電器時，模組上對應的繼電器旁 LED 會亮</p>\n<h1 id=\"設定-bytes-說明\"><a class=\"anchor\" href=\"#設定-bytes-說明\">#</a> 設定 Bytes 說明</h1>\n<table>\n<thead>\n<tr>\n<th>Byte 位置</th>\n<th>說明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>0</td>\n<td>命令標頭（通常是固定值）</td>\n</tr>\n<tr>\n<td>1</td>\n<td>控制命令</td>\n</tr>\n<tr>\n<td>2</td>\n<td>要控制的繼電器位元組（bitmask）</td>\n</tr>\n<tr>\n<td>3~8</td>\n<td>充填位元</td>\n</tr>\n</tbody>\n</table>\n<h1 id=\"程式設計思路\"><a class=\"anchor\" href=\"#程式設計思路\">#</a> 程式設計思路</h1>\n<ul>\n<li>使用 class</li>\n<li>constructor 進行 init, 可指定 device path 或自動搜尋</li>\n<li>每個 relay on/off 使用的 bytes 用 list 儲存</li>\n<li>setOff(channelNumber), setOn(channelNumber)</li>\n<li>根據機械手臂動作定義，ActionOK (), ActionNG ()</li>\n<li>切為 on 之後多久復歸原狀態可調整</li>\n</ul>\n<h1 id=\"部份程式碼\"><a class=\"anchor\" href=\"#部份程式碼\">#</a> 部份程式碼</h1>\n<figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"><span>setOn()</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 啟動第幾個 relay</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">setOn</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">number</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">const</span> commandList <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token comment\">// all</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token punctuation\">[</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xFE</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token comment\">// 第一個 relay</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token punctuation\">[</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xFF</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x01</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token comment\">// 第二個 relay</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token punctuation\">[</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xFF</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x02</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token comment\">// 第三個 relay</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">[</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xFF</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x03</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token comment\">// 第四個 relay</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token punctuation\">[</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xFF</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x04</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token comment\">// 第五個 relay</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token punctuation\">[</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xFF</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x05</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token comment\">// 第六個 relay</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">[</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xFF</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x06</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token comment\">// 第七個 relay</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token punctuation\">[</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xFF</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x07</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token comment\">// 第八個 relay</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token punctuation\">[</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xFF</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x08</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>device<span class=\"token punctuation\">.</span><span class=\"token function\">sendFeatureReport</span><span class=\"token punctuation\">(</span>commandList<span class=\"token punctuation\">[</span>number<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"><span>setOff()</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 關閉第幾個 relay</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">setOff</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">number</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">const</span> commandList <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token comment\">// all</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token punctuation\">[</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xFC</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token comment\">// 第一個 relay</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token punctuation\">[</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xFD</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x01</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token comment\">// 第二個 relay</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token punctuation\">[</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xFD</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x02</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token comment\">// 第三個 relay</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">[</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xFD</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x03</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token comment\">// 第四個 relay</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token punctuation\">[</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xFD</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x04</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token comment\">// 第五個 relay</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token punctuation\">[</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xFD</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x05</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token comment\">// 第六個 relay</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">[</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xFD</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x06</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token comment\">// 第七個 relay</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token punctuation\">[</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xFD</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x07</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token comment\">// 第八個 relay</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token punctuation\">[</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xFD</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x08</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>device<span class=\"token punctuation\">.</span><span class=\"token function\">sendFeatureReport</span><span class=\"token punctuation\">(</span>commandList<span class=\"token punctuation\">[</span>number<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"><span>ActionOK()</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ActionOK</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\">//relay 1 作為 OK 訊號</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setOn</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><figure class=\"highlight javascript\"><figcaption data-lang=\"javascript\"><span>ActionNG()</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ActionNG</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\">//relay 2 作為 NG 訊號</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setOn</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"備註\"><a class=\"anchor\" href=\"#備註\">#</a> 備註</h1>\n<ul>\n<li>注意輸出控制可承受負載範圍，通常在繼電器上會標示</li>\n<li>需要 HID 支援的模組</li>\n<li>參考 <a href=\"https://github.com/josephdadams/USBRelay\">https://github.com/josephdadams/USBRelay</a></li>\n<li>模組由 USB 供電，拔掉後 relay 狀態會重置</li>\n</ul>\n",
            "tags": [
                "Node.js",
                "USB Relay"
            ]
        },
        {
            "id": "https://8loser.github.io/2024/11/08/gcp-mutual-tls/",
            "url": "https://8loser.github.io/2024/11/08/gcp-mutual-tls/",
            "title": "GCP mTLS(mutual TLS) 憑證設定",
            "date_published": "2024-11-08T15:38:07.000Z",
            "content_html": "<h1 id=\"緣由\"><a class=\"anchor\" href=\"#緣由\">#</a> 緣由</h1>\n<p>有一網站需要限制只有特定人員才可瀏覽，通常會使用來源 IP 進行限制，若是無固定辦公室人員（業務）則使用 VPN 連入公司網路獲得允許 IP。</p>\n<p>但因為公司沒有自己的網路，所以沒辦法使用這個方法，因此採用 mTLS。</p>\n<p>一般網站憑證只是單向用於驗證網站是否合法，mTLS 則是雙向驗證 <span class=\"spoiler\" title=\"你知道得太多了\">雙向奔赴的憑證</span>，除了驗證網站是否合法外，也驗證連接端 (client, browser) 是否合法。</p>\n<p>官方文件其實有教學 (<a href=\"https://cloud.google.com/load-balancing/docs/https/setting-up-mtls-ccm\">Set up mutual TLS with user-provided certificates</a>)，但是官方文件都是透過 gcloud 設定，所以這篇紀錄一下怎麼使用 GUI 方式設定。</p>\n<p>思路：從 load balance 下手，在 load balance 進行驗證，client 合法才導入後端。</p>\n<h1 id=\"需求\"><a class=\"anchor\" href=\"#需求\">#</a> 需求</h1>\n<p>先安裝 openssl 用於產生憑證</p>\n<h1 id=\"產生根憑證\"><a class=\"anchor\" href=\"#產生根憑證\">#</a> 產生根憑證</h1>\n<h2 id=\"憑證設定檔\"><a class=\"anchor\" href=\"#憑證設定檔\">#</a> 憑證設定檔</h2>\n<p>建立憑證設定檔  <code>example.cnf</code></p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>[req]</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>distinguished_name = empty_distinguished_name</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>[empty_distinguished_name]</pre></td></tr><tr><td data-num=\"4\"></td><td><pre># Kept empty to allow setting via -subj command line arg.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>[ca_exts]</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>basicConstraints=critical,CA:TRUE</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>keyUsage=keyCertSign</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>extendedKeyUsage=clientAuth</pre></td></tr></table></figure><h2 id=\"根憑證與密鑰\"><a class=\"anchor\" href=\"#根憑證與密鑰\">#</a> 根憑證與密鑰</h2>\n<p>使用 openssl 產生根憑證密鑰  <code>root.key</code>  與根憑證  <code>root.cert</code></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>openssl req <span class=\"token parameter variable\">-x509</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token parameter variable\">-new</span> <span class=\"token parameter variable\">-sha256</span> <span class=\"token parameter variable\">-newkey</span> rsa:2048 <span class=\"token parameter variable\">-nodes</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token parameter variable\">-days</span> <span class=\"token number\">3650</span> <span class=\"token parameter variable\">-subj</span> <span class=\"token string\">'/CN=root'</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token parameter variable\">-config</span> example.cnf <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token parameter variable\">-extensions</span> ca_exts <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token parameter variable\">-keyout</span> root.key <span class=\"token parameter variable\">-out</span> root.cert</pre></td></tr></table></figure><h1 id=\"產生中繼憑證\"><a class=\"anchor\" href=\"#產生中繼憑證\">#</a> 產生中繼憑證</h1>\n<h2 id=\"中繼憑證簽名請求\"><a class=\"anchor\" href=\"#中繼憑證簽名請求\">#</a> 中繼憑證簽名請求</h2>\n<p>產生中繼憑證密鑰  <code>int.key</code>  跟中繼憑證簽名請求  <code>int.req</code></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>openssl req <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token parameter variable\">-new</span> <span class=\"token parameter variable\">-sha256</span> <span class=\"token parameter variable\">-newkey</span> rsa:2048 <span class=\"token parameter variable\">-nodes</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token parameter variable\">-subj</span> <span class=\"token string\">'/CN=int'</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token parameter variable\">-config</span> example.cnf <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token parameter variable\">-extensions</span> ca_exts <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token parameter variable\">-keyout</span> int.key <span class=\"token parameter variable\">-out</span> int.req</pre></td></tr></table></figure><h2 id=\"中繼憑證\"><a class=\"anchor\" href=\"#中繼憑證\">#</a> 中繼憑證</h2>\n<p>產生中繼憑證  <code>int.cert</code></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>openssl x509 <span class=\"token parameter variable\">-req</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token parameter variable\">-CAkey</span> root.key <span class=\"token parameter variable\">-CA</span> root.cert <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token parameter variable\">-set_serial</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token parameter variable\">-days</span> <span class=\"token number\">3650</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token parameter variable\">-extfile</span> example.cnf <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token parameter variable\">-extensions</span> ca_exts <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token parameter variable\">-in</span> int.req <span class=\"token parameter variable\">-out</span> int.cert</pre></td></tr></table></figure><h1 id=\"建立信任設定\"><a class=\"anchor\" href=\"#建立信任設定\">#</a> 建立信任設定</h1>\n<p>從 <a href=\"https://console.cloud.google.com/security/ccm/list/trustConfigs\">https://console.cloud.google.com/security/ccm/list/trustConfigs</a> 建立信任設定<br />\n把前面步驟產生的  <code>root.cert</code>  內容增加到信任錨點、 <code>int.cert</code>  內容增加到中繼 CA。</p>\n<p><img loading=\"lazy\" src=\"trust-config.jpg\" alt=\"信任設定\" /></p>\n<h1 id=\"建立用戶端驗證\"><a class=\"anchor\" href=\"#建立用戶端驗證\">#</a> 建立用戶端驗證</h1>\n<p>從 <a href=\"https://console.cloud.google.com/net-security/clientauth/serverTlsPolicies\">https://console.cloud.google.com/net-security/clientauth/serverTlsPolicies</a> 建立用戶端驗證<br />\n用戶端驗證模式選擇  <code>負載平衡</code>  以及  <code>拒絕無效的用戶憑證</code> ，信任設定選取前一步驟建立的設定檔。<br />\n<img loading=\"lazy\" src=\"client-auth.jpg\" alt=\"用戶端驗證\" /></p>\n<h1 id=\"負載平衡設定\"><a class=\"anchor\" href=\"#負載平衡設定\">#</a> 負載平衡設定</h1>\n<p><a href=\"https://console.cloud.google.com/net-services/loadbalancing/list/loadBalancers\">https://console.cloud.google.com/net-services/loadbalancing/list/loadBalancers</a><br />\n 在負載平衡的前端設定處，選取剛建立的用戶端驗證，可能不會馬上生效，如果生效後開啟網址會是  <code>ERR_CONNECTION_CLOSED</code>  的訊息。</p>\n<p><img loading=\"lazy\" src=\"load-balance.jpg\" alt=\"負載平衡\" /></p>\n<h1 id=\"建立用戶端憑證\"><a class=\"anchor\" href=\"#建立用戶端憑證\">#</a> 建立用戶端憑證</h1>\n<h2 id=\"用戶端設定檔\"><a class=\"anchor\" href=\"#用戶端設定檔\">#</a> 用戶端設定檔</h2>\n<p>建立用戶端設定檔  <code>client.config</code></p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>[req]</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>default_bits              = 2048</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>req_extensions            = extension_requirements</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>distinguished_name        = dn_requirements</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>prompt                    = no</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>[extension_requirements]</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>basicConstraints          = critical, CA:FALSE</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>keyUsage                  = critical, nonRepudiation, digitalSignature, keyEncipherment</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>extendedKeyUsage          = clientAuth</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>[dn_requirements]</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>countryName               = US</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>stateOrProvinceName       = California</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>localityName              = San Francisco</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>0.organizationName        = example</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>organizationalUnitName    = test</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>commonName                = test.example.com</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>emailAddress              = test@example.com</pre></td></tr></table></figure><h2 id=\"產生用戶密鑰與簽名請求\"><a class=\"anchor\" href=\"#產生用戶密鑰與簽名請求\">#</a> 產生用戶密鑰與簽名請求</h2>\n<p>會產生  <code>client.key</code> ,  <code>client.csr</code> 。這邊會詢問金鑰密碼，後面匯出時會用到。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>openssl req <span class=\"token parameter variable\">-new</span> <span class=\"token parameter variable\">-keyout</span> client.key <span class=\"token parameter variable\">-out</span> client.csr <span class=\"token parameter variable\">-config</span> client.config</pre></td></tr></table></figure><h2 id=\"產生用戶端憑證\"><a class=\"anchor\" href=\"#產生用戶端憑證\">#</a> 產生用戶端憑證</h2>\n<p>使用  <code>int.cert</code> 、 <code>int.key</code> 、 <code>client.csr</code>  產生用戶端憑證  <code>client.cert</code></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>openssl x509 <span class=\"token parameter variable\">-req</span> <span class=\"token parameter variable\">-in</span> client.csr <span class=\"token parameter variable\">-out</span> client.cert <span class=\"token parameter variable\">-extfile</span> client.config <span class=\"token parameter variable\">-extensions</span> extension_requirements <span class=\"token parameter variable\">-days</span> <span class=\"token number\">365</span> <span class=\"token parameter variable\">-CA</span> int.cert <span class=\"token parameter variable\">-CAkey</span> int.key</pre></td></tr></table></figure><p>測試</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-v</span> <span class=\"token parameter variable\">-k</span> <span class=\"token parameter variable\">--key</span> client.key <span class=\"token parameter variable\">--cert</span> client.cert https://網址</pre></td></tr></table></figure><h1 id=\"瀏覽器匯入憑證\"><a class=\"anchor\" href=\"#瀏覽器匯入憑證\">#</a> 瀏覽器匯入憑證</h1>\n<p>server 端大致上設置完成，還需設定 client 端，client 匯入憑證這邊使用  <code>PKCS #12</code>  格式。<br />\n首先將  <code>client.key</code> 、 <code>client.cert</code>  封裝。會產生  <code>client.p12</code> 。<br />\n這邊會詢問剛剛產生  <code>client.key</code>  時的金鑰密碼，驗證後會再詢問金鑰匯出密碼，在匯入時會需要 (可不設置)。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>openssl pkcs12 <span class=\"token parameter variable\">-export</span> <span class=\"token parameter variable\">-inkey</span> client.key <span class=\"token parameter variable\">-in</span> client.cert <span class=\"token parameter variable\">-out</span> client.p12 <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"client-cert\"</span></pre></td></tr></table></figure><h2 id=\"憑證匯入\"><a class=\"anchor\" href=\"#憑證匯入\">#</a> 憑證匯入</h2>\n<p>在 Windows、Linux 桌面環境大致上都直接點兩下  <code>client.p12</code>  後輸入匯出密碼即可。之後可開啟瀏覽器查看網站是否可正常瀏覽。</p>\n<p>macOS 可能會出現一直詢問密碼 (匯出密碼錯誤) 的情況，強者我同事說是因為  <code>openssl</code>  版本差異關係，使用舊版的  <code>openssl</code>  重新匯出 p12 憑證即可。</p>\n<p>macOS 還需要從  <code>鑰匙圈</code>  設定憑證的存取權限為一律允許，否則在瀏覽網站的時候，會一直出現詢問密碼請求允許的情況。</p>\n",
            "tags": [
                "Step By Step",
                "GCP",
                "mutual TLS",
                "憑證",
                "SSL"
            ]
        },
        {
            "id": "https://8loser.github.io/2024/06/17/dev-container-bind-source-error/",
            "url": "https://8loser.github.io/2024/06/17/dev-container-bind-source-error/",
            "title": "bind source path does not exist",
            "date_published": "2024-06-16T16:38:53.000Z",
            "content_html": "<h1 id=\"問題描述\"><a class=\"anchor\" href=\"#問題描述\">#</a> 問題描述</h1>\n<p>DevContainer 啟動 container 錯誤，查看錯誤訊息如下<br />\n <code>Error response from daemon: invalid mount config for type &quot;bind&quot;: bind source path does not exist: /run/user/1000/wayland-0</code></p>\n<h1 id=\"環境\"><a class=\"anchor\" href=\"#環境\">#</a> 環境</h1>\n<ul>\n<li>OS: EndeavourOS</li>\n<li>在 VSCode 使用 Dev Container 套件啟動 container</li>\n</ul>\n<h1 id=\"修正方法\"><a class=\"anchor\" href=\"#修正方法\">#</a> 修正方法</h1>\n<p>刪除下面兩個檔案</p>\n<ul>\n<li>/run/user/1000/wayland-0</li>\n<li>/run/user/1000/wayland-0.lock</li>\n</ul>\n",
            "tags": [
                "Trouble",
                "VSCode",
                "Remote Container"
            ]
        },
        {
            "id": "https://8loser.github.io/2024/06/16/shokaX-waline-comment/",
            "url": "https://8loser.github.io/2024/06/16/shokaX-waline-comment/",
            "title": "Hexo ShokaX 主題使用 Waline 留言版",
            "date_published": "2024-06-15T17:17:17.000Z",
            "content_html": "<h1 id=\"佈署-waline-server-端\"><a class=\"anchor\" href=\"#佈署-waline-server-端\">#</a> 佈署 Waline server 端</h1>\n<p>參考 Waline 佈署教學網站 <a href=\"https://waline.js.org/guide/deploy/vercel.html\">https://waline.js.org/guide/deploy/vercel.html</a> ，點選 Deploy 按鈕，會跳轉 Vercel 頁面建立 Waline server。</p>\n<p><img loading=\"lazy\" src=\"vercel-deploy.png\" alt=\"Vercel deploy\" /></p>\n<p>如果使用該方式，在 Vercel 出現下面錯誤訊息，改用這個 <a href=\"https://vercel.com/new/austin-lees-projects/clone?repository-url=https%3A%2F%2Fgithub.com%2Fwalinejs%2Fwaline%2Ftree%2Fmain%2Fexample\">[Deploy]</a> 試試</p>\n<div class=\"note danger\">\n<p>Error: No Output Directory named &quot;dist&quot; found after the Build completed. You can configure the Output Directory in your  Project Settings.</p>\n</div>\n<div class=\"note info\">\n<p>除了 Vercel 作為 Waline 服務之外，也有其他選擇 <a href=\"https://waline.js.org/guide/get-started/server.html\">https://waline.js.org/guide/get-started/server.html</a></p>\n</div>\n<h1 id=\"建立-waline-使用的資料庫\"><a class=\"anchor\" href=\"#建立-waline-使用的資料庫\">#</a> 建立 Waline 使用的資料庫</h1>\n<p>Waline 需要資料庫儲存留言資料，Waline 支援多種資料庫 <a href=\"https://waline.js.org/guide/database.html\">https://waline.js.org/guide/database.html</a> 。<br />\nVercel 也有提供資料庫，所以這邊使用 Vercel 內建的資料庫服務，建立 PostgreSQL。</p>\n<p><img loading=\"lazy\" src=\"vercel-create-database.png\" alt=\"Create Database Step1\" /></p>\n<p><img loading=\"lazy\" src=\"vercel-create-postgres.png\" alt=\"Create Database Step2\" /></p>\n<div class=\"note info\">\n<p>需要的資料表請參考<br />\n<a href=\"https://github.com/walinejs/waline/blob/main/assets/waline.pgsql\"> https://github.com/walinejs/waline/blob/main/assets/waline.pgsql</a></p>\n</div>\n<h1 id=\"將-waline-服務與資料庫連接\"><a class=\"anchor\" href=\"#將-waline-服務與資料庫連接\">#</a> 將 Waline 服務與資料庫連接</h1>\n<p>進入 App<br />\n<img loading=\"lazy\" src=\"enter-waline-app.png\" alt=\"Enter Waline App\" /><br />\n 連接剛剛建立的 PostgreSQL<br />\n<img loading=\"lazy\" src=\"database-connect.png\" alt=\"Database connect\" /></p>\n<h1 id=\"設定-waline-環境變數\"><a class=\"anchor\" href=\"#設定-waline-環境變數\">#</a> 設定 Waline 環境變數</h1>\n<p><img loading=\"lazy\" src=\"setting-environment-variable.png\" alt=\"Setting environment variable\" /></p>\n<p>如果資料庫連接成功，會看到紅框內的環境變數。<br />\n<img loading=\"lazy\" src=\"waline-environment-variable.png\" alt=\"Connected Success Variable\" /></p>\n<p>但這樣還無法讓 Waline server 成功連接資料庫，還需要設定下面的環境變數</p>\n<ul>\n<li>PG_SSL\n<ul>\n<li>設為 true</li>\n</ul>\n</li>\n<li>PG_PORT\n<ul>\n<li>設為 5432</li>\n</ul>\n</li>\n</ul>\n<div class=\"note info\">\n<p>Waline 可設定的 PostgreSQL 環境變數<br />\n<a href=\"https://waline.js.org/guide/database.html#postgresql\"> https://waline.js.org/guide/database.html#postgresql</a></p>\n</div>\n<h1 id=\"測試-waline-功能\"><a class=\"anchor\" href=\"#測試-waline-功能\">#</a> 測試 Waline 功能</h1>\n<p>進入 Waline project 查看 Waline 留言頁面。</p>\n<p><img loading=\"lazy\" src=\"app-visit-test.png\" alt=\"Visit Waline app\" /></p>\n<p>如果正常的話會看到如下畫面，可以留言測試看看是否成功。</p>\n<p><img loading=\"lazy\" src=\"waline-comment-page.png\" alt=\"Waline comment page\" /></p>\n<h1 id=\"設定-shokax\"><a class=\"anchor\" href=\"#設定-shokax\">#</a> 設定 ShokaX</h1>\n<p>修改 Hexo ShokaX 設定檔；Hexo 資料夾  <code>/_config.shokax.yml</code>  或  <code>/_config.shokaX.yml</code></p>\n<p>增加下面設定</p>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"><span>_config.shokax.yml</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">waline</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">enable</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span> <span class=\"token comment\"># 啟用狀態</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token key atrule\">serverURL</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"https://waline-three-wine.vercel.app\"</span> <span class=\"token comment\"># Waline server 網址，從 Vercel Project 查看 domain</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">lang</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"zh-TW\"</span> <span class=\"token comment\"># comment 界面語言</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token key atrule\">meta</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># comment 可填寫項目</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">-</span> nick</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">-</span> mail</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token key atrule\">requiredMeta</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># comment 必填項目</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">-</span> nick</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">-</span> mail</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token key atrule\">wordLimit</span><span class=\"token punctuation\">:</span> <span class=\"token number\">400</span> <span class=\"token comment\"># comment 字數上限</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token key atrule\">pageSize</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span> <span class=\"token comment\"># 每頁顯示筆數</span></pre></td></tr></table></figure><div class=\"note info\">\n<p>Hexo ShokaX 的 Waline 其他設定項目<br />\n<a href=\"https://docs.kaitaku.xyz/guide/comment.html#valine-%E7%B3%BB%E8%AF%84%E8%AE%BA%E7%B3%BB%E7%BB%9F\"> https://docs.kaitaku.xyz/guide/comment.html#valine - 系评论系统</a></p>\n</div>\n<h1 id=\"使用紀錄\"><a class=\"anchor\" href=\"#使用紀錄\">#</a> 使用紀錄</h1>\n<h2 id=\"202406\"><a class=\"anchor\" href=\"#202406\">#</a> 2024/06</h2>\n<ul>\n<li>meta 設定無效，只設定 nick, mail 但是界面上還是會顯示網址欄位</li>\n<li><code>最新評論</code>  顯示 emoji 無效，會變成 HTML</li>\n</ul>\n",
            "tags": [
                "Step By Step",
                "Hexo theme",
                "Waline"
            ]
        },
        {
            "id": "https://8loser.github.io/2023/10/30/spawn-node-gyp-ENOENT/",
            "url": "https://8loser.github.io/2023/10/30/spawn-node-gyp-ENOENT/",
            "title": "spawn node-gyp ENOENT",
            "date_published": "2023-10-29T17:04:26.000Z",
            "content_html": "<h1 id=\"問題描述\"><a class=\"anchor\" href=\"#問題描述\">#</a> 問題描述</h1>\n<p>要把 theme 轉為 <a href=\"https://docs.kaitaku.xyz/\">shokaX</a> 時，執行  <code>SXC install shokaX</code>  出現錯誤訊息</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>error /workspaces/page/node_modules/deasync: Command failed.</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Exit code: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Command: <span class=\"token function\">node</span> ./build.js</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Arguments: </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Directory: /workspaces/page/node_modules/deasync</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Output:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>node:events:495</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      throw er<span class=\"token punctuation\">;</span> // Unhandled <span class=\"token string\">'error'</span> event</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      ^</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>Error: spawn node-gyp ENOENT</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    at ChildProcess._handle.onexit <span class=\"token punctuation\">(</span>node:internal/child_process:284:19<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    at onErrorNT <span class=\"token punctuation\">(</span>node:internal/child_process:477:16<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    at process.processTicksAndRejections <span class=\"token punctuation\">(</span>node:internal/process/task_queues:82:21<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>Emitted <span class=\"token string\">'error'</span> event on ChildProcess instance at:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    at ChildProcess._handle.onexit <span class=\"token punctuation\">(</span>node:internal/child_process:290:12<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    at onErrorNT <span class=\"token punctuation\">(</span>node:internal/child_process:477:16<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    at process.processTicksAndRejections <span class=\"token punctuation\">(</span>node:internal/process/task_queues:82:21<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  errno: -2,</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  code: <span class=\"token string\">'ENOENT'</span>,</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  syscall: <span class=\"token string\">'spawn node-gyp'</span>,</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  path: <span class=\"token string\">'node-gyp'</span>,</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  spawnargs: <span class=\"token punctuation\">[</span> <span class=\"token string\">'rebuild'</span> <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>Node.js v18.18.2</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>info Visit https://yarnpkg.com/en/docs/cli/add <span class=\"token keyword\">for</span> documentation about this command.</pre></td></tr></table></figure><h1 id=\"環境\"><a class=\"anchor\" href=\"#環境\">#</a> 環境</h1>\n<ul>\n<li>Docker image: node:18-slim</li>\n</ul>\n<h1 id=\"修正方法\"><a class=\"anchor\" href=\"#修正方法\">#</a> 修正方法</h1>\n<p>安裝下面套件，不確定  <code>make</code> ,  <code>g++</code>  需不需要，因為之前遇過類似的問題都裝這三個，所以直接複製過來用。如果沒有安裝的話，在安裝  <code>node-gyp</code>  會出現其他錯誤。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">-y</span> python3 <span class=\"token function\">make</span> g++</pre></td></tr></table></figure><p>安裝  <code>node-gyp</code></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">pnpm</span> <span class=\"token function\">add</span> <span class=\"token parameter variable\">-g</span> node-gyp</pre></td></tr></table></figure>",
            "tags": [
                "Trouble",
                "Docker",
                "Hexo",
                "Shoka",
                "Node.js"
            ]
        },
        {
            "id": "https://8loser.github.io/2023/08/27/static-web-page-refresh-404/",
            "url": "https://8loser.github.io/2023/08/27/static-web-page-refresh-404/",
            "title": "靜態網頁 refresh 出現 404",
            "date_published": "2023-08-26T16:40:55.000Z",
            "content_html": "<h1 id=\"trouble\"><a class=\"anchor\" href=\"#trouble\">#</a> Trouble</h1>\n<p>Vue 開發網頁打包成靜態網頁檔案，使用 docker compose 結合 nginx 佈署，網頁切換到有路徑的頁面後按 F5 重新整理頁面會出現 404 錯誤 。</p>\n<p>靜態頁面打包後有再用 <a href=\"https://acme.com/software/thttpd/\">thttpd</a> 作為 web 服務並打包成 container 方便佈署，實際錯誤情況如下圖，如果不同的 web 服務會有不同畫面。</p>\n<p><img loading=\"lazy\" src=\"404-not-found.png\" alt=\"404 Not Found\" /></p>\n<h1 id=\"docker-composeyml\"><a class=\"anchor\" href=\"#docker-composeyml\">#</a> Docker-compose.yml</h1>\n<p>有修改過的內容，實際不只有兩個 container</p>\n<figure class=\"highlight dockerfile\"><figcaption data-lang=\"Docker\"><span>docker-compose.yml</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>services:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  nginx:</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    image: nginx</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    restart: unless-stopped</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    volumes:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token comment\"># nginx 設定檔</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      - ./nginx.conf:/etc/nginx/conf.d/default.conf</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      - ./robots.txt.test:/usr/share/nginx/html/robots.txt</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    environment:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      TZ: Asia/Taipei</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    ports:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      - target: 80</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        published: 80</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        protocol: tcp</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        mode: host</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token comment\"># 前端 web service</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  branded:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    image: ***馬賽克***</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    restart: unless-stopped</pre></td></tr></table></figure><h1 id=\"nginxconf\"><a class=\"anchor\" href=\"#nginxconf\">#</a> Nginx.conf</h1>\n<figure class=\"highlight nginx\"><figcaption data-lang=\"nginx\"><span>nginx.conf</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token directive\"><span class=\"token keyword\">server</span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token directive\"><span class=\"token keyword\">listen</span> <span class=\"token number\">80</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token directive\"><span class=\"token keyword\">server_name</span> <span class=\"token string\">\"\"</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\"># LB Public IP address</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token directive\"><span class=\"token keyword\">set_real_ip_from</span> ***馬賽克***</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token directive\"><span class=\"token keyword\">set_real_ip_from</span> 130.211.0.0/22</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token directive\"><span class=\"token keyword\">set_real_ip_from</span> 35.191.0.0/16</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token directive\"><span class=\"token keyword\">real_ip_header</span> X-Forwarded-For</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token directive\"><span class=\"token keyword\">real_ip_recursive</span> <span class=\"token boolean\">on</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token comment\"># 阻擋的 User Agent</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token directive\"><span class=\"token keyword\">if</span> (<span class=\"token variable\">$http_user_agent</span> ~* ***不要告訴泥*** )</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span>return <span class=\"token directive\"><span class=\"token keyword\">101</span></span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token directive\"><span class=\"token keyword\">location</span> /robots.txt</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">alias</span> /usr/share/nginx/html/robots.txt</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token directive\"><span class=\"token keyword\">location</span> /healthcheck</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">access_log</span> <span class=\"token boolean\">off</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">return</span> <span class=\"token number\">200</span> <span class=\"token string\">'ok'</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token comment\"># 前端</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token directive\"><span class=\"token keyword\">location</span> /</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">proxy_pass</span> http://branded/</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> Host <span class=\"token variable\">$host</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> X-Real-IP <span class=\"token variable\">$remote_addr</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> X-Custom-Referrer smc_identity_layer</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"solution\"><a class=\"anchor\" href=\"#solution\">#</a> Solution</h1>\n<p>在 nginx.conf 加上</p>\n<pre><code>proxy_intercept_errors on;\nerror_page 404 /index.html;\n</code></pre>\n<figure class=\"highlight nginx\"><figcaption data-lang=\"nginx\"><span>nginx.conf</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 前端</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token directive\"><span class=\"token keyword\">location</span> /</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">proxy_pass</span> http://branded/</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> Host <span class=\"token variable\">$host</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> X-Real-IP <span class=\"token variable\">$remote_addr</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">proxy_set_header</span> X-Custom-Referrer smc_identity_layer</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\"># 高情商 (?) 加下面這兩行</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">proxy_intercept_errors</span> <span class=\"token boolean\">on</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token directive\"><span class=\"token keyword\">error_page</span> <span class=\"token number\">404</span> /index.html</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure>",
            "tags": [
                "Trouble",
                "Deploy",
                "Nginx",
                "static web page",
                "Docker Compose"
            ]
        },
        {
            "id": "https://8loser.github.io/2023/07/14/fixing-mixed-content/",
            "url": "https://8loser.github.io/2023/07/14/fixing-mixed-content/",
            "title": "瀏覽器出現 Mixed Content 訊息",
            "date_published": "2023-07-14T11:25:05.000Z",
            "content_html": "<p>Chrome Console 出現  <code>Mixed Content</code>  訊息</p>\n<pre><code>Mixed Content: The page at 'https://www.***.com/' was loaded over HTTPS, but requested an insecure XMLHttpRequest endpoint 'http://192.168.10.200:3000/'. \nThis request has been blocked; the content must be served over HTTPS.\n</code></pre>\n<p>出現該訊息是因為在 https 頁面內，呼叫 http 協定的 API，基於安全問題，瀏覽器會封鎖該請求。解決方式是把 API 換成 https 即可，但這個 API 是我們放在客戶端存取客戶內部網路的 service，讓客戶在我們網站透過呼叫該 service 存取他們內網資料。</p>\n<p>如果要為了這個 service 建立域名、申請 SSL 憑證有點麻煩（我就懶），所以請客戶調整瀏覽器設定，允許不安全內容。</p>\n<p><img loading=\"lazy\" src=\"allow-insecure-content.png\" alt=\"Allow insecure conten\" /></p>\n<h1 id=\"相關參考\"><a class=\"anchor\" href=\"#相關參考\">#</a> 相關參考</h1>\n<ul>\n<li>\n<p><a href=\"https://support.google.com/chrome/answer/114662?hl=zh-Hant&amp;co=GENIE.Platform%3DDesktop#zippy=%2C%E7%9E%AD%E8%A7%A3%E5%8F%AF%E8%AE%8A%E6%9B%B4%E7%9A%84%E6%AC%8A%E9%99%90\">變更網站設定權限</a></p>\n</li>\n<li>\n<p><a href=\"https://developer.mozilla.org/zh-TW/docs/Web/Security/Mixed_content\">混合內容</a></p>\n</li>\n</ul>\n",
            "tags": [
                "Trouble",
                "Mixed Content",
                "Browser"
            ]
        },
        {
            "id": "https://8loser.github.io/2023/05/28/yay-is-corrupted/",
            "url": "https://8loser.github.io/2023/05/28/yay-is-corrupted/",
            "title": "yay 更新顯示檔案毀損",
            "date_published": "2023-05-28T10:03:54.000Z",
            "content_html": "<h1 id=\"問題描述\"><a class=\"anchor\" href=\"#問題描述\">#</a> 問題描述</h1>\n<p>EndeavourOS 更新時出現錯誤訊息，且每次更新時都出現。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>:: 進行安裝嗎？ <span class=\"token punctuation\">[</span>Y/n<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>:: 正在接收軟體包…</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> libusbmuxd-2.0.2-3-x86_64            <span class=\"token number\">31.8</span> KiB   <span class=\"token number\">529</span> KiB/s 00:00 <span class=\"token punctuation\">[</span>------------------------------------<span class=\"token punctuation\">]</span> <span class=\"token number\">100</span>%</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> libplist-2.3.0-2-x86_64             <span class=\"token number\">140.7</span> KiB  <span class=\"token number\">1315</span> KiB/s 00:00 <span class=\"token punctuation\">[</span>------------------------------------<span class=\"token punctuation\">]</span> <span class=\"token number\">100</span>%</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> libimobiledevice-1.3.0-9-x86_64     <span class=\"token number\">481.5</span> KiB  <span class=\"token number\">2.35</span> MiB/s 00:00 <span class=\"token punctuation\">[</span>------------------------------------<span class=\"token punctuation\">]</span> <span class=\"token number\">100</span>%</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> yay-12.0.5-1-x86_64                   <span class=\"token number\">3.0</span> MiB  <span class=\"token number\">2.69</span> MiB/s 00:01 <span class=\"token punctuation\">[</span>------------------------------------<span class=\"token punctuation\">]</span> <span class=\"token number\">100</span>%</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> 總共 <span class=\"token punctuation\">(</span><span class=\"token number\">4</span>/4<span class=\"token punctuation\">)</span>                            <span class=\"token number\">3.7</span> MiB  <span class=\"token number\">3.23</span> MiB/s 00:01 <span class=\"token punctuation\">[</span>------------------------------------<span class=\"token punctuation\">]</span> <span class=\"token number\">100</span>%</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token number\">78</span>/78<span class=\"token punctuation\">)</span> 正在檢查鑰匙圈中的鑰匙                                   <span class=\"token punctuation\">[</span>------------------------------------<span class=\"token punctuation\">]</span> <span class=\"token number\">100</span>%</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token number\">78</span>/78<span class=\"token punctuation\">)</span> 正在檢查軟體包完整性                                     <span class=\"token punctuation\">[</span>------------------------------------<span class=\"token punctuation\">]</span> <span class=\"token number\">100</span>%</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>錯誤：yay：來自 manuel <span class=\"token operator\">&lt;</span>manuel@endeavouros.com<span class=\"token operator\">></span> 的簽章信任等級不明::  /var/cache/pacman/pkg/yay-12.0.5-1-x86_64.pkg.tar.zst 檔案毀損<span class=\"token punctuation\">(</span>套件不正確或損毀（PGP 簽章）<span class=\"token punctuation\">)</span>。你要刪除它嗎? <span class=\"token punctuation\">[</span>Y/n<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>錯誤：無法提交處理 <span class=\"token punctuation\">(</span>套件不正確或損毀（PGP 簽章）<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>發生錯誤，沒有軟體包被更新。</pre></td></tr></table></figure><h1 id=\"修正\"><a class=\"anchor\" href=\"#修正\">#</a> 修正</h1>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> pacman <span class=\"token parameter variable\">-Sy</span> archlinux-keyring endeavouros-keyring</pre></td></tr></table></figure><p>修正後執行  <code>yay -Syu</code>  可正常更新了。</p>\n",
            "tags": [
                "Trouble",
                "EndeavourOS",
                "Linux"
            ]
        },
        {
            "id": "https://8loser.github.io/2023/05/06/dbeaver-backup-start-unavailable/",
            "url": "https://8loser.github.io/2023/05/06/dbeaver-backup-start-unavailable/",
            "title": "DBeaver backup start 按鈕沒有作用",
            "date_published": "2023-05-06T14:57:59.000Z",
            "content_html": "<h1 id=\"問題描述\"><a class=\"anchor\" href=\"#問題描述\">#</a> 問題描述</h1>\n<p>在 Linux 內 DBeaver backup  <code>Start</code>  按鈕無法點選，也無法  <code>Next</code></p>\n<p><img loading=\"lazy\" src=\"start-unavailable.png\" alt=\"start unavailable\" /></p>\n<h1 id=\"環境\"><a class=\"anchor\" href=\"#環境\">#</a> 環境</h1>\n<ul>\n<li>OS: EndeavourOS, BUILD_ID=2023.03.06</li>\n<li>DBeaver\tCommunity 23.0.3</li>\n<li>Database: 雲端 PostgreSQL</li>\n</ul>\n<h1 id=\"修正方法\"><a class=\"anchor\" href=\"#修正方法\">#</a> 修正方法</h1>\n<h2 id=\"安裝-postgresql\"><a class=\"anchor\" href=\"#安裝-postgresql\">#</a> 安裝 PostgreSQL</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> pacman <span class=\"token parameter variable\">-S</span> postgresql</pre></td></tr></table></figure><h2 id=\"查看-pg_dump-位置\"><a class=\"anchor\" href=\"#查看-pg_dump-位置\">#</a> 查看 pg_dump 位置</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ <span class=\"token function\">whereis</span> pg_dump</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>pg_dump: /usr/bin/pg_dump /usr/share/man/man1/pg_dump.1.gz</pre></td></tr></table></figure><p>知道  <code>pg_dump</code>  程式位置在  <code>/usr/bin/</code></p>\n<h2 id=\"dbeaver-設定-driver\"><a class=\"anchor\" href=\"#dbeaver-設定-driver\">#</a> DBeaver 設定 Driver</h2>\n<p>從 DBeaver 選單開啟 Database/Driver Manager，點選 PostgreSQL 按  <code>Edit</code> <br />\n<img loading=\"lazy\" src=\"driver-manager.png\" alt=\"Driver Manager\" /></p>\n<p>選取  <code>Native Client</code> / <code>Add Home</code></p>\n<p><img loading=\"lazy\" src=\"native-client.png\" alt=\"Native Client\" /></p>\n<p>設定 Home 為  <code>/usr/bin/</code></p>\n<p><img loading=\"lazy\" src=\"add-home.png\" alt=\"Add Home\" /></p>\n<h1 id=\"測試\"><a class=\"anchor\" href=\"#測試\">#</a> 測試</h1>\n<p><code>Next</code>  可以點選了<br />\n<img loading=\"lazy\" src=\"backup-next.png\" alt=\"Backup Next\" /></p>\n<p>點選  <code>Next</code>  後，選取備份路徑按  <code>Start</code>  就可以備份了<br />\n<img loading=\"lazy\" src=\"backup-start.png\" alt=\"Backup Start\" /></p>\n",
            "tags": [
                "Trouble",
                "Linux",
                "DBeaver"
            ]
        },
        {
            "id": "https://8loser.github.io/2023/03/12/reduce-frontend-docker-image/",
            "url": "https://8loser.github.io/2023/03/12/reduce-frontend-docker-image/",
            "title": "縮減靜態網頁 Docker image 大小",
            "date_published": "2023-03-12T13:59:19.000Z",
            "content_html": "<h1 id=\"前言\"><a class=\"anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>通常 Vue 部屬都是先打包成靜態網頁再部屬到 web 服務器上，但如此無法做到程式碼上傳版控後自動部屬，因為上傳的是原始碼，不是打包後的靜態網頁。</p>\n<p>所以 Vue 搭配 Docker 時，有種作法是把原始碼直接直接 build 成執行  <code>npm run dev</code>  的 docker image 後放在 server 執行。</p>\n<p><img loading=\"lazy\" src=\"jsut-do-it.jpg\" alt=\"\" /></p>\n<div class=\"note danger\">\n<p>這種作法產生的 docker image 很大，枉費還用 Vue</p>\n</div>\n<h1 id=\"縮減方式\"><a class=\"anchor\" href=\"#縮減方式\">#</a> 縮減方式</h1>\n<p>使用 <a href=\"https://docs.docker.com/build/building/multi-stage/\">Multi-stage builds</a>，在第一個 stage build 出靜態網頁，複製到第二個 stage 跟 web service 打包成 image。</p>\n<p>假設原本 Dockerfiler 如下</p>\n<figure class=\"highlight dockerfile\"><figcaption data-lang=\"Docker\"><span>fat Dockerfile</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> node:18-slim</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">COPY</span> . .</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">RUN</span> npm install --production=false</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">EXPOSE</span> 5173</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">CMD</span> [<span class=\"token string\">\"npm\"</span>,<span class=\"token string\">\"run\"</span>,<span class=\"token string\">\"dev\"</span>]</span></pre></td></tr></table></figure><p>加上第二個 stage，並且使用 <a href=\"https://acme.com/software/thttpd/\">thttpd</a> 作為靜態網頁的 web service</p>\n<figure class=\"highlight dockerfile\"><figcaption data-lang=\"Docker\"><span>slim Dockerfile</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 第一個 stage</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> node:18-slim <span class=\"token keyword\">AS</span> builder</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">COPY</span> . .</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">RUN</span> npm install --production=false</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># build static html 檔案，檔案會產生在 /dist 內</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">RUN</span> npm run build</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># 第二個 stage</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> alpine</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># 安裝 thttpd</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">RUN</span> apk update &amp;&amp; apk upgrade &amp;&amp; apk add --no-cache thttpd</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\"># 複製第一個 stage 產生的 static html 到 /front</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">COPY</span> <span class=\"token options\"><span class=\"token property\">--from</span><span class=\"token punctuation\">=</span><span class=\"token string\">builder</span></span> /dist /front</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">EXPOSE</span> 5173</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\"># container 啟動時執行 thttpd</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">CMD</span> [<span class=\"token string\">\"thttpd\"</span>, <span class=\"token string\">\"-D\"</span>, <span class=\"token string\">\"-h\"</span>, <span class=\"token string\">\"0.0.0.0\"</span>, <span class=\"token string\">\"-p\"</span>, <span class=\"token string\">\"5173\"</span>, <span class=\"token string\">\"-d\"</span>, <span class=\"token string\">\"/front\"</span>, <span class=\"token string\">\"-l\"</span>, <span class=\"token string\">\"-\"</span>, <span class=\"token string\">\"-M\"</span>, <span class=\"token string\">\"60\"</span>]</span></pre></td></tr></table></figure><p><img loading=\"lazy\" src=\"finish.gif\" alt=\"\" /></p>\n<h1 id=\"比較\"><a class=\"anchor\" href=\"#比較\">#</a> 比較</h1>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\"></th>\n<th style=\"text-align:center\">Docker image 大小</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">修改前</td>\n<td style=\"text-align:center\">504MB</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">修改後</td>\n<td style=\"text-align:center\">11.1MB</td>\n</tr>\n</tbody>\n</table>\n<p><img loading=\"lazy\" src=\"whoa.gif\" alt=\"\" /></p>\n",
            "tags": [
                "Docker"
            ]
        },
        {
            "id": "https://8loser.github.io/2023/03/11/EndeavourOS-init/",
            "url": "https://8loser.github.io/2023/03/11/EndeavourOS-init/",
            "title": "EndeavourOS 常用程式安裝",
            "date_published": "2023-03-11T13:23:40.000Z",
            "content_html": "<h1 id=\"參數說明\"><a class=\"anchor\" href=\"#參數說明\">#</a> 參數說明</h1>\n<ul>\n<li><code>--noconfirm</code>  自動確認</li>\n<li><code>--needed</code>  已安裝的套件不重複安裝</li>\n</ul>\n<h1 id=\"注音輸入法-新酷音\"><a class=\"anchor\" href=\"#注音輸入法-新酷音\">#</a> 注音輸入法 (新酷音)</h1>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pacman <span class=\"token parameter variable\">-S</span> <span class=\"token parameter variable\">--noconfirm</span> <span class=\"token parameter variable\">--needed</span> fcitx5 fcitx5-im fcitx5-chinese-addons fcitx5-configtool fcitx5-chewing</pre></td></tr></table></figure><p>修改  <code>/etc/environment</code>  檔案，增加下面設定</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token assign-left variable\">GTK_IM_MODULE</span><span class=\"token operator\">=</span>fcitx</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token assign-left variable\">QT_IM_MODULE</span><span class=\"token operator\">=</span>fcitx</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\"><span class=\"token environment constant\">XMODIFIERS</span></span><span class=\"token operator\">=</span>@im<span class=\"token operator\">=</span>fcitx</pre></td></tr></table></figure><h1 id=\"藍芽\"><a class=\"anchor\" href=\"#藍芽\">#</a> 藍芽</h1>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pacman <span class=\"token parameter variable\">-S</span> <span class=\"token parameter variable\">--noconfirm</span> <span class=\"token parameter variable\">--needed</span> bluez bluez-utils blueberry</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 設定開機自動啟用</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>systemctl <span class=\"token builtin class-name\">enable</span> bluetooth</pre></td></tr></table></figure><h1 id=\"visual-studio-code\"><a class=\"anchor\" href=\"#visual-studio-code\">#</a> Visual Studio Code</h1>\n<p>安裝 AUR 的 bin 版本才有 Remote Development 套件</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yay <span class=\"token parameter variable\">-S</span> <span class=\"token parameter variable\">--noconfirm</span> <span class=\"token parameter variable\">--needed</span> visual-studio-code-bin</pre></td></tr></table></figure><h1 id=\"docker\"><a class=\"anchor\" href=\"#docker\">#</a> Docker</h1>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pacman <span class=\"token parameter variable\">-S</span> <span class=\"token parameter variable\">--noconfirm</span> <span class=\"token parameter variable\">--needed</span> <span class=\"token function\">docker</span></pre></td></tr></table></figure><h1 id=\"docker-desktop\"><a class=\"anchor\" href=\"#docker-desktop\">#</a> Docker Desktop</h1>\n<p>要先下載安裝檔案</p>\n<div class=\"note info\">\n<p>下載版本，可參考 <a href=\"https://docs.docker.com/desktop/release-notes/\">https://docs.docker.com/desktop/release-notes/</a></p>\n</div>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 下載套件檔案</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token assign-left variable\">dockerDesktopFile</span><span class=\"token operator\">=</span>docker-desktop-4.17.0-x86_64.pkg.tar.zst</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">wget</span> https://desktop.docker.com/linux/main/amd64/<span class=\"token variable\">$dockerDesktopFile</span> <span class=\"token parameter variable\">-P</span> /tmp</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 安裝套件</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>pacman <span class=\"token parameter variable\">-U</span> <span class=\"token parameter variable\">--noconfirm</span> /tmp/<span class=\"token variable\">$dockerDesktopFile</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 移除下載的檔案</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">rm</span> /tmp/<span class=\"token variable\">$dockerDesktopFile</span></pre></td></tr></table></figure><div class=\"note info\">\n<p>手動安裝可參考 <a href=\"https://docs.docker.com/desktop/install/archlinux/\">https://docs.docker.com/desktop/install/archlinux/</a></p>\n</div>\n<h1 id=\"google-chrome\"><a class=\"anchor\" href=\"#google-chrome\">#</a> Google Chrome</h1>\n<p>AUR 才有</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yay <span class=\"token parameter variable\">-S</span> <span class=\"token parameter variable\">--noconfirm</span> <span class=\"token parameter variable\">--needed</span> google-chrome</pre></td></tr></table></figure><h1 id=\"設定-ram-disk\"><a class=\"anchor\" href=\"#設定-ram-disk\">#</a> 設定 RAM disk</h1>\n<p>建立檔案  <code>/etc/tmpfiles.d/shmFolder.conf</code> <br />\n 使用者名稱的位置記得修改</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 下載資料夾</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>d /dev/shm/Downloads 0755 <span class=\"token operator\">&lt;</span>使用者名稱<span class=\"token operator\">></span> <span class=\"token operator\">&lt;</span>使用者名稱<span class=\"token operator\">></span> - -</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>L+ /home/<span class=\"token operator\">&lt;</span>使用者名稱<span class=\"token operator\">></span>/Downloads - - - - /dev/shm/Downloads</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># Chrome 暫存資料夾</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>d /dev/shm/ChromeCache 0700 <span class=\"token operator\">&lt;</span>使用者名稱<span class=\"token operator\">></span> <span class=\"token operator\">&lt;</span>使用者名稱<span class=\"token operator\">></span> - -</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>L+ /home/<span class=\"token operator\">&lt;</span>使用者名稱<span class=\"token operator\">></span>/.cache/google-chrome - - - - /dev/shm/ChromeCache</pre></td></tr></table></figure><p>執行使設定檔生效，或者重新開機</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemd-tmpfiles <span class=\"token parameter variable\">--create</span></pre></td></tr></table></figure><h1 id=\"完整-shell-script\"><a class=\"anchor\" href=\"#完整-shell-script\">#</a> 完整 Shell Script</h1>\n<p>在這裡 <a href=\"https://gist.github.com/8loser/a99f0e946861db9a368693ab747c5506\">EndeavourOS-init.sh</a></p>\n",
            "tags": [
                "EndeavourOS",
                "Linux",
                "Shell script"
            ]
        },
        {
            "id": "https://8loser.github.io/2023/02/23/linux-recovering-journal/",
            "url": "https://8loser.github.io/2023/02/23/linux-recovering-journal/",
            "title": "Linux 開機顯示 recovering journal",
            "date_published": "2023-02-23T08:51:28.000Z",
            "content_html": "<h1 id=\"描述\"><a class=\"anchor\" href=\"#描述\">#</a> 描述</h1>\n<p>Linux 作業系統開機顯示 recovering journal，無法正常進入桌面環境。<br />\n完整訊息如下，出現  <code>recovering journal</code>  後，要等個幾分鐘才會再出現後續的訊息。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"><span>開機訊息</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>/dev/nvme0n1p5: recovering journal</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>/dev/nvme0n1p5: clean, <span class=\"token number\">1217915</span>/16416000 files, <span class=\"token number\">17252131</span>/65536000 blocks</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span> TIME <span class=\"token punctuation\">]</span> Timed out waiting <span class=\"token keyword\">for</span> device /dev/sda2.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>DEPEND<span class=\"token punctuation\">]</span> Dependency failed <span class=\"token keyword\">for</span> /home/user/test.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>DEPEND<span class=\"token punctuation\">]</span> Dependency failed <span class=\"token keyword\">for</span> Local File System.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>You are <span class=\"token keyword\">in</span> emergency mode. After logging in, <span class=\"token builtin class-name\">type</span> <span class=\"token string\">\"journalctl -xb\"</span> to view system logs, <span class=\"token string\">\"systemctl reboot\"</span> to reboot, <span class=\"token string\">\"systemctl default\"</span> or <span class=\"token string\">\"exit\"</span> to boot into default mode.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Give root password <span class=\"token keyword\">for</span> maintenance</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">(</span>or press Control-D to <span class=\"token builtin class-name\">continue</span><span class=\"token punctuation\">)</span>:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><h1 id=\"環境\"><a class=\"anchor\" href=\"#環境\">#</a> 環境</h1>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"><span>系統環境</span></figcaption><table><tr class=\"marked\"><td data-num=\"1\"></td><td><pre>$ lsb_release <span class=\"token parameter variable\">-a</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>LSB Version:\tn/a</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Distributor ID:\tManjaroLinux</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Description:\tManjaro Linux</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Release:\t<span class=\"token number\">22.0</span>.4</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Codename:\tSikaris</pre></td></tr></table></figure><h1 id=\"修正\"><a class=\"anchor\" href=\"#修正\">#</a> 修正</h1>\n<p>使用 root 權限編輯  <code>/etc/fstab</code> ，把  <code>/dev/sda2</code>  (錯誤訊息中顯示的) 那行刪除，儲存，reboot。</p>\n<h1 id=\"原因\"><a class=\"anchor\" href=\"#原因\">#</a> 原因</h1>\n<p>應該是我前一次關機前，插外接硬碟又用 partition 管理工具 mount 外接硬碟 partition 導致。</p>\n",
            "tags": [
                "Trouble",
                "Linux"
            ]
        },
        {
            "id": "https://8loser.github.io/2023/02/20/terminals-pty-host-is-unresponsive/",
            "url": "https://8loser.github.io/2023/02/20/terminals-pty-host-is-unresponsive/",
            "title": "Dev Containers 出現 terminal's pty host process is unresponsive",
            "date_published": "2023-02-20T06:10:40.000Z",
            "content_html": "<h1 id=\"錯誤訊息\"><a class=\"anchor\" href=\"#錯誤訊息\">#</a> 錯誤訊息</h1>\n<div class=\"note success\">\n<p>Visual Studio Code 1.76.1 版本已不會有此問題</p>\n</div>\n<p>更新 Visual Studio Code 後，進入 Dev Containers 出現錯誤  <code>The connection to the terminal's pty host process is unresponsive</code> ，且 terminal 無法使用。<br />\n<img loading=\"lazy\" src=\"error-message.png\" alt=\"Error message\" /></p>\n<p>點選  <code>Restart pty host</code>  後 terminal 仍無法正常顯示</p>\n<h1 id=\"環境\"><a class=\"anchor\" href=\"#環境\">#</a> 環境</h1>\n<ul>\n<li>作業系統</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"><span>系統資訊</span></figcaption><table><tr class=\"marked\"><td data-num=\"1\"></td><td><pre>$ lsb_release  <span class=\"token parameter variable\">-a</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>LSB Version:\tn/a</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Distributor ID:\tManjaroLinux</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Description:\tManjaro Linux</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Release:\t<span class=\"token number\">22.0</span>.4</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Codename:\tSikaris</pre></td></tr></table></figure><ul>\n<li>Visual Studio Code 1.75.1 (會出現錯誤的版本)</li>\n</ul>\n<h1 id=\"嘗試修正\"><a class=\"anchor\" href=\"#嘗試修正\">#</a> 嘗試修正</h1>\n<p>Visual Studio Code 設定 terminal.integrated.windowsEnableConpty: false，重啟後異常狀況一樣。</p>\n<h1 id=\"使用-downgrade-降版\"><a class=\"anchor\" href=\"#使用-downgrade-降版\">#</a> 使用 downgrade 降版</h1>\n<p>無法降版，可能因為我先把 VSCode 刪除再重新安裝，而重新安裝是最新版的，所以電腦內沒有保留舊版本。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr class=\"marked\"><td data-num=\"1\"></td><td><pre>$ <span class=\"token function\">sudo</span> downgrade visual-studio-code-bin</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Downgrading from A.L.A. is disabled on the stable branch. To override this behavior, <span class=\"token builtin class-name\">set</span> DOWNGRADE_FROM_ALA to <span class=\"token number\">1</span>.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>See https://wiki.manjaro.org/index.php/Downgrading_packages  <span class=\"token keyword\">for</span> <span class=\"token function\">more</span> details.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>No results found</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Unable to downgrade visual-studio-code-bin</pre></td></tr></table></figure><h1 id=\"直接安裝舊版本\"><a class=\"anchor\" href=\"#直接安裝舊版本\">#</a> 直接安裝舊版本</h1>\n<h2 id=\"取得舊版本\"><a class=\"anchor\" href=\"#取得舊版本\">#</a> 取得舊版本</h2>\n<p>從 <a href=\"https://aur.archlinux.org/packages/\">AUR repository</a> 找到使用的套件<a href=\"https://aur.archlinux.org/packages/visual-studio-code-bin\"> visual-studio-code-bin</a>，點選  <code>View Changes</code>  查看舊版本。</p>\n<p><img loading=\"lazy\" src=\"aur-package.png\" alt=\"AUR package\" /></p>\n<p>選擇可以正常的版本；1.74.3，下載套件。</p>\n<p><img loading=\"lazy\" src=\"aur-package-changes.png\" alt=\"AUR package changes\" /><br />\n<img loading=\"lazy\" src=\"old-package-download.png\" alt=\"old package download\" /></p>\n<h2 id=\"建立-package\"><a class=\"anchor\" href=\"#建立-package\">#</a> 建立 package</h2>\n<p>解壓縮後進入</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"><span>解壓縮後的檔案清單</span></figcaption><table><tr class=\"marked\"><td data-num=\"1\"></td><td><pre>$ <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-a1</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">.</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">..</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>code.desktop</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>code-url-handler.desktop</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>PKGBUILD</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>.SRCINFO</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>visual-studio-code-bin.install</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>visual-studio-code-bin.sh</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>visual-studio-code-workspace.xml</pre></td></tr></table></figure><p>建立 package</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"><span>建立 package</span></figcaption><table><tr class=\"marked\"><td data-num=\"1\"></td><td><pre>$ makepkg <span class=\"token parameter variable\">-s</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">></span> Making package: visual-studio-code-bin <span class=\"token number\">1.74</span>.3-1 <span class=\"token punctuation\">(</span>廿廿三年二月廿日 <span class=\"token punctuation\">(</span>週一<span class=\"token punctuation\">)</span> 廿時47分十三秒<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">></span> Checking runtime dependencies<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">></span> Checking buildtime dependencies<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">></span> Retrieving sources<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  -<span class=\"token operator\">></span> Found code.desktop</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  -<span class=\"token operator\">></span> Found code-url-handler.desktop</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  -<span class=\"token operator\">></span> Found visual-studio-code-workspace.xml</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  -<span class=\"token operator\">></span> Found visual-studio-code-bin.sh</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  -<span class=\"token operator\">></span> Downloading code_x64_1.74.3.tar.gz<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                                 Dload  Upload   Total   Spent    Left  Speed</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token number\">100</span>   <span class=\"token number\">134</span>  <span class=\"token number\">100</span>   <span class=\"token number\">134</span>    <span class=\"token number\">0</span>     <span class=\"token number\">0</span>    <span class=\"token number\">159</span>      <span class=\"token number\">0</span> --:--:-- --:--:-- --:--:--   <span class=\"token number\">159</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token number\">100</span>  131M  <span class=\"token number\">100</span>  131M    <span class=\"token number\">0</span>     <span class=\"token number\">0</span>  3979k      <span class=\"token number\">0</span>  <span class=\"token number\">0</span>:00:33  <span class=\"token number\">0</span>:00:33 --:--:-- 4091k</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">></span> Validating <span class=\"token builtin class-name\">source</span> files with sha256sums<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    code.desktop <span class=\"token punctuation\">..</span>. Passed</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    code-url-handler.desktop <span class=\"token punctuation\">..</span>. Passed</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    visual-studio-code-workspace.xml <span class=\"token punctuation\">..</span>. Passed</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    visual-studio-code-bin.sh <span class=\"token punctuation\">..</span>. Passed</pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">></span> Validating source_x86_64 files with sha256sums<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    code_x64_1.74.3.tar.gz <span class=\"token punctuation\">..</span>. Passed</pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">></span> Extracting sources<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  -<span class=\"token operator\">></span> Extracting code_x64_1.74.3.tar.gz with bsdtar</pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">></span> Entering fakeroot environment<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">></span> Starting package<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">></span> Tidying install<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  -<span class=\"token operator\">></span> Removing libtool files<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  -<span class=\"token operator\">></span> Purging unwanted files<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  -<span class=\"token operator\">></span> Removing static library files<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  -<span class=\"token operator\">></span> Stripping unneeded symbols from binaries and libraries<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  -<span class=\"token operator\">></span> Compressing <span class=\"token function\">man</span> and info pages<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">></span> Checking <span class=\"token keyword\">for</span> packaging issues<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">></span> Creating package <span class=\"token string\">\"visual-studio-code-bin\"</span><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  -<span class=\"token operator\">></span> Generating .PKGINFO file<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  -<span class=\"token operator\">></span> Generating .BUILDINFO file<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  -<span class=\"token operator\">></span> Adding <span class=\"token function\">install</span> file<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  -<span class=\"token operator\">></span> Generating .MTREE file<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  -<span class=\"token operator\">></span> Compressing package<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">></span> Leaving fakeroot environment.</pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">></span> Finished making: visual-studio-code-bin <span class=\"token number\">1.74</span>.3-1 <span class=\"token punctuation\">(</span>廿廿三年二月廿日 <span class=\"token punctuation\">(</span>週一<span class=\"token punctuation\">)</span> 廿時48分二秒<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>建立 package 後會產生需要的檔案，檢查有沒有產生  <code>visual-studio-code-bin-1.74.3-1-x86_64.pkg.tar.zst</code> 。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"><span>建立 package 後產生需要的檔案</span></figcaption><table><tr class=\"marked\"><td data-num=\"1\"></td><td><pre>$ <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-a1</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">.</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">..</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>code.desktop</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>code-url-handler.desktop</pre></td></tr><tr class=\"marked\"><td data-num=\"6\"></td><td><pre>code_x64_1.74.3.tar.gz</pre></td></tr><tr class=\"marked\"><td data-num=\"7\"></td><td><pre>pkg</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>PKGBUILD</pre></td></tr><tr class=\"marked\"><td data-num=\"9\"></td><td><pre>src</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>.SRCINFO</pre></td></tr><tr class=\"marked\"><td data-num=\"11\"></td><td><pre>visual-studio-code-bin-1.74.3-1-x86_64.pkg.tar.zst</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>visual-studio-code-bin.install</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>visual-studio-code-bin.sh</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>visual-studio-code-workspace.xml</pre></td></tr></table></figure><h2 id=\"安裝\"><a class=\"anchor\" href=\"#安裝\">#</a> 安裝</h2>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"><span>安裝 package</span></figcaption><table><tr class=\"marked\"><td data-num=\"1\"></td><td><pre>$ <span class=\"token function\">sudo</span> pacman <span class=\"token parameter variable\">-U</span> visual-studio-code-bin-1.74.3-1-x86_64.pkg.tar.zst</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>loading packages<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>resolving dependencies<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>looking <span class=\"token keyword\">for</span> conflicting packages<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Packages <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> visual-studio-code-bin-1.74.3-1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Total Installed Size:  <span class=\"token number\">331.05</span> MiB</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>:: Proceed with installation? <span class=\"token punctuation\">[</span>Y/n<span class=\"token punctuation\">]</span> y</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>/1<span class=\"token punctuation\">)</span> checking keys <span class=\"token keyword\">in</span> keyring                                   <span class=\"token punctuation\">[</span><span class=\"token comment\">####################################] 100%</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>/1<span class=\"token punctuation\">)</span> checking package integrity                                 <span class=\"token punctuation\">[</span><span class=\"token comment\">####################################] 100%</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>/1<span class=\"token punctuation\">)</span> loading package files                                      <span class=\"token punctuation\">[</span><span class=\"token comment\">####################################] 100%</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>/1<span class=\"token punctuation\">)</span> checking <span class=\"token keyword\">for</span> <span class=\"token function\">file</span> conflicts                                <span class=\"token punctuation\">[</span><span class=\"token comment\">####################################] 100%</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>/1<span class=\"token punctuation\">)</span> checking available disk space                              <span class=\"token punctuation\">[</span><span class=\"token comment\">####################################] 100%</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>:: Processing package changes<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>/1<span class=\"token punctuation\">)</span> installing visual-studio-code-bin                          <span class=\"token punctuation\">[</span><span class=\"token comment\">####################################] 100%</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">></span> NOTE: Custom flags should be put directly in: ~/.config/code-flags.conf</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>Optional dependencies <span class=\"token keyword\">for</span> visual-studio-code-bin</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    glib2: Needed <span class=\"token keyword\">for</span> move to trash functionality <span class=\"token punctuation\">[</span>installed<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    libdbusmenu-glib: Needed <span class=\"token keyword\">for</span> KDE global menu <span class=\"token punctuation\">[</span>installed<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    org.freedesktop.secrets: Needed <span class=\"token keyword\">for</span> settings <span class=\"token function\">sync</span> <span class=\"token punctuation\">[</span>installed<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    icu69: Needed <span class=\"token keyword\">for</span> live share</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>:: Running post-transaction hooks<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token number\">1</span>/4<span class=\"token punctuation\">)</span> Arming ConditionNeedsUpdate<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token number\">2</span>/4<span class=\"token punctuation\">)</span> Updating the MIME <span class=\"token builtin class-name\">type</span> database<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token number\">3</span>/4<span class=\"token punctuation\">)</span> Refreshing PackageKit<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token number\">4</span>/4<span class=\"token punctuation\">)</span> Updating the desktop <span class=\"token function\">file</span> MIME <span class=\"token builtin class-name\">type</span> cache<span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><h1 id=\"注意事項\"><a class=\"anchor\" href=\"#注意事項\">#</a> 注意事項</h1>\n<p>在 Linux 環境要安裝  <code>visual-studio-code-bin</code>  的版本，才有  <code>Remote Development</code>  套件可以安裝。</p>\n<p><img loading=\"lazy\" src=\"package-visual-studio-code-bin.png\" alt=\"Visual Studio Code bin\" /></p>\n<h1 id=\"參考資料\"><a class=\"anchor\" href=\"#參考資料\">#</a> 參考資料</h1>\n<ul>\n<li><a href=\"https://github.com/microsoft/vscode-remote-release/issues/7999\">https://github.com/microsoft/vscode-remote-release/issues/7999</a></li>\n<li><a href=\"https://github.com/microsoft/vscode/issues/130320\">https://github.com/microsoft/vscode/issues/130320</a></li>\n</ul>\n",
            "tags": [
                "Trouble",
                "VSCode",
                "Remote Development"
            ]
        },
        {
            "id": "https://8loser.github.io/2023/02/19/newbie-guide/",
            "url": "https://8loser.github.io/2023/02/19/newbie-guide/",
            "title": "新手指南",
            "date_published": "2023-02-19T07:04:11.000Z",
            "content_html": "<h1 id=\"新手指南\"><a class=\"anchor\" href=\"#新手指南\">#</a> 新手指南</h1>\n<p>這是一篇新手進公司後整理內部開發流程的 <s>事故</s> 故事</p>\n<h1 id=\"要有光\"><a class=\"anchor\" href=\"#要有光\">#</a> 要有光</h1>\n<p>上班第一天，要緊頭一件事就是 <span class=\"spoiler\" title=\"你知道得太多了\">認清自己在食物鏈中的位置</span> 熟悉開發環境，目前公司開發到佈署的流程是原始碼在每個人的環境都有一份，如果有修改再傳修改的檔案給知道怎麼佈署的人去佈署，這方式有時後會漏掉檔案，也很難搞清哪個才是最新版本的程式。而且每個人開發環境不同，剛拿到專案原始碼時啟動失敗，同學會教我一些奇計淫巧至今令我匪夷所思的方法（為什麼要修改 node_modules 內的檔案？）。</p>\n<ul>\n<li>改的檔案是最新版的嗎？</li>\n<li>覆蓋別人給的檔案後，原本改好的程式不見了。</li>\n<li>你給的檔案無法執行，說有缺少 function。</li>\n<li>『可以只給提供修改的 function 嗎？』「我其實也不太確定耶，還是你整個貼上後試試看有沒有錯誤」</li>\n</ul>\n<h1 id=\"新手村\"><a class=\"anchor\" href=\"#新手村\">#</a> 新手村</h1>\n<p>村長跟我介紹村子內 NPC 的功能，還有 server 的佈署方式，程式碼上傳到 GCP linux VM 後使用 docker build 成 image，再使用 docker compose 啟動多個 container 運行服務。有兩個 VM 每個 VM 都有 5 個 container，除了前端、後端程式外還有串接其他服務，使用的程式語言有 Vue.js, Node.js, .NET Core 。</p>\n<h1 id=\"程式一致\"><a class=\"anchor\" href=\"#程式一致\">#</a> 程式一致</h1>\n<p>為了解決程式碼同步問題，挑了可以免費 private 託管的版本控制服務，同學可以遠端上傳程式碼，其他人也可以同步。</p>\n<ol>\n<li class=\"quiz\">使用的服務為 <span class=\"gap\"></span> 。\n<ul class=\"options\">\n<li class=\"correct\">GitHub</li>\n<li>PornHub</li>\n</ul>\n</li>\n</ol>\n<p>為什麼要選 GitHub 而不是 <s>PornHub</s> GitLab？忘記了，好像跟 CI/CD 的免費項目有關。難的不是選擇使用的版控服務，而是要上傳哪些程式碼？通常在 server 上運行的就是最新的程式碼，使用 <a href=\"https://winscp.net/\">WinSCP</a> 抓下來後當作基準，因為其他同學還有改到一半未上傳的程式碼，所以也收集其他同學的程式碼進行整理合併。整理時發現不是每個人的開發環境設置都一樣，有的人用 Windows 有的人用 Mac。</p>\n<p><div class=\"links\"><div class=\"item\" title=\"WinSCP\" style=\"--block-color:#e9546b;\"><a href=\"https://winscp.net/\" class=\"image\" data-background-image=\"https://winscp-static-746341.c.cdn77.org/assets/images/logos/logo.png?v=7008\"></a>\n        <div class=\"info\">\n        <a href=\"https://winscp.net/\" class=\"title\">WinSCP</a>\n        <p class=\"desc\">https://winscp.net/</p>\n        </div></div></div></p>\n<h1 id=\"環境一致\"><a class=\"anchor\" href=\"#環境一致\">#</a> 環境一致</h1>\n<p>雖然程式碼一致了，但相同的程式碼在不同開發環境卻會出現異常，<span class=\"spoiler\" title=\"你知道得太多了\">你就用 node 14 就好了阿，沒事幹麻升級自找麻煩 😒</span> 所以開發環境也要一致。最簡單的方法是大家都裝相同的 node 版本，凡是都有個 BUT，全部的專案使用的 node 並不是相同版本，而且不是每個人都會用 <a href=\"https://github.com/nvm-sh/nvmNVM\">NVM</a>。<br />\n雖然有的人用 Mac 有的人用 Windows，但是大家都是用 Visual Studio Code，所以把全部的專案都加上 <a href=\"https://code.visualstudio.com/docs/devcontainers/tutorial\">Dev Containers</a>，之後所有人開發的時候，都使用 <a href=\"https://code.visualstudio.com/docs/devcontainers/tutorial\">Dev Containers</a> 進入 container 進行開發。</p>\n<p><div class=\"links\"><div class=\"item\" title=\"visual Studio Code\" style=\"--block-color:#e9546b;\"><a href=\"https://code.visualstudio.com/docs/devcontainers/containers\" class=\"image\" data-background-image=\"/assets/404.png\"></a>\n        <div class=\"info\">\n        <a href=\"https://code.visualstudio.com/docs/devcontainers/containers\" class=\"title\">Developing inside a Container</a>\n        <p class=\"desc\">https://code.visualstudio.com/docs/devcontainers/containers</p>\n        </div></div><div class=\"item\" title=\"八樓的人\" style=\"--block-color:#e9546b;\"><a href=\"/2022/05/13/Remote-Containers/\" class=\"image\" data-background-image=\"/assets/avatar.jpg\"></a>\n        <div class=\"info\">\n        <a href=\"/2022/05/13/Remote-Containers/\" class=\"title\">使用 VSCode 在 Docker container 內進行開發</a>\n        <p class=\"desc\">/2022/05/13/Remote-Containers/</p>\n        </div></div></div></p>\n<h1 id=\"docker-image-auto-build\"><a class=\"anchor\" href=\"#docker-image-auto-build\">#</a> Docker image auto build</h1>\n<p>上面提到程式最後都在 server 上 build image 後，使用 docker compose 建立 container 執行。 <ins>你終究要 image 的那為什麼不一開始就 image？</ins> 所以把每個專案都加上 <a href=\"https://docs.github.com/en/actions/quickstart\">GitHub Action</a>，引用原本就有的 Dockerfile 修改，程式上傳後會自動打包成 docker image 且 push 到 <a href=\"https://docs.github.com/en/packages/learn-github-packages/introduction-to-github-packages\">GitHub Package</a></p>\n<p>在 GitHub Action 使用下面的 yml，程式碼上傳到 GitHub 後會自動打包成 docker image</p>\n<p><a href=\"https://gist.github.com/8loser/4f78378d21358e8d4174bb9e8d872af3\">Gist Auto build docker image yml</a></p>\n<p>如果設定成功 push 程式碼後可以在 GitHub Action 看到執行動作<br />\n<img loading=\"lazy\" src=\"github-action.png\" alt=\"GitHub Action\" /></p>\n<p><div class=\"links\"><div class=\"item\" title=\"Quickstart for GitHub Actions\" style=\"--block-color:#e9546b;\"><a href=\"https://docs.github.com/en/actions/quickstart\" class=\"image\" data-background-image=\"/assets/404.png\"></a>\n        <div class=\"info\">\n        <a href=\"https://docs.github.com/en/actions/quickstart\" class=\"title\">Quickstart for GitHub Actions</a>\n        <p class=\"desc\">https://docs.github.com/en/actions/quickstart</p>\n        </div></div><div class=\"item\" title=\"docker/build-push-action\" style=\"--block-color:#e9546b;\"><a href=\"https://github.com/docker/build-push-action\" class=\"image\" data-background-image=\"/assets/404.png\"></a>\n        <div class=\"info\">\n        <a href=\"https://github.com/docker/build-push-action\" class=\"title\">docker/build-push-action</a>\n        <p class=\"desc\">https://github.com/docker/build-push-action</p>\n        </div></div></div></p>\n<h1 id=\"docker-管理\"><a class=\"anchor\" href=\"#docker-管理\">#</a> Docker 管理</h1>\n<p>鑑於不是所有同學都習慣用 linux，所以在 server 裝上 <a href=\"https://www.portainer.io\">portainer</a>，可以使用 Web 界面控制 server 上的 docker。一天又平安的過去了，感謝飛天小女警的努力。</p>\n<p><div class=\"links\"><div class=\"item\" title=\"Install Portainer CE with Docker on Linux\" style=\"--block-color:#e9546b;\"><a href=\"https://docs.portainer.io/start/install-ce/server/docker/linux\" class=\"image\" data-background-image=\"/assets/404.png\"></a>\n        <div class=\"info\">\n        <a href=\"https://docs.portainer.io/start/install-ce/server/docker/linux\" class=\"title\">Install Portainer CE with Docker on Linux</a>\n        <p class=\"desc\">https://docs.portainer.io/start/install-ce/server/docker/linux</p>\n        </div></div></div></p>\n<h1 id=\"自動佈署\"><a class=\"anchor\" href=\"#自動佈署\">#</a> 自動佈署</h1>\n<p>出現 bug 急著修正的時候，可能一天要上傳程式到 server 八百次，但不是所有人都知道怎麼更新到 server，<span class=\"spoiler\" title=\"你知道得太多了\">所以維運的同學要多體諒工程師</span> 所以在 portainer 開啟 swarm 功能後，service 就可以啟用 webhook 接收更新通知，收到通知後自動 pull 新的 docker image 進行佈署，不知道怎麼佈署的人可以  <code>POST</code>  呼叫 webhook 進行 service 更新。</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"><span>開啟 docker swarm 方法</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> swarm init</pre></td></tr></table></figure><p>設定完成後可以在 portainer 選單看到 service 項目<br />\n<img loading=\"lazy\" src=\"portainer-menu.png\" alt=\"portainer menu\" /></p>\n<p>進入 service 可以開啟  <code>Service webhook</code> ，產生的網址就是用來接收通知拉取新 image 重新佈署的<br />\n<img loading=\"lazy\" src=\"portainer-service.png\" alt=\"portainer service\" /></p>\n<p>更新 service 還要呼叫 webhook 有點麻煩，就交給 GitHub Action 吧！<br />\n在 GitHub Action 加入下面設定後，每次 push/pull_request (根據 main.yml 設定) 就會自動更新。</p>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"><span>呼叫 webhook 進行更新</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Call webhook update service</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> muinmomin/webhook<span class=\"token punctuation\">-</span>action@v1.0.0</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 要通知的 webhook URL</span></pre></td></tr></table></figure><p><div class=\"links\"><div class=\"item\" title=\"portainer.io\" style=\"--block-color:#e9546b;\"><a href=\"https://docs.portainer.io/user/docker/services/webhooks#enabling-a-service-webhook\" class=\"image\" data-background-image=\"/assets/404.png\"></a>\n        <div class=\"info\">\n        <a href=\"https://docs.portainer.io/user/docker/services/webhooks#enabling-a-service-webhook\" class=\"title\">Enabling a service webhook</a>\n        <p class=\"desc\">https://docs.portainer.io/user/docker/services/webhooks#enabling-a-service-webhook</p>\n        </div></div><div class=\"item\" title=\"muinmomin/webhook-action\" style=\"--block-color:#e9546b;\"><a href=\"https://github.com/muinmomin/webhook-action\" class=\"image\" data-background-image=\"/assets/404.png\"></a>\n        <div class=\"info\">\n        <a href=\"https://github.com/muinmomin/webhook-action\" class=\"title\">muinmomin/webhook-action</a>\n        <p class=\"desc\">https://github.com/muinmomin/webhook-action</p>\n        </div></div></div></p>\n<h1 id=\"正式站測試站\"><a class=\"anchor\" href=\"#正式站測試站\">#</a> 正式站 / 測試站</h1>\n<p>當業務外出跟客戶展示系統功能時，如果網站一直更新重啟服務中斷，在客戶端的同學會很尷尬，<span class=\"spoiler\" title=\"你知道得太多了\">所以有業務在外展示時工程師可以放假</span> 所以把線上系統分為正式站跟測試站。</p>\n<ul class=\"task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_0\" checked=\"true\" disabled=\"true\" /><label for=\"cbx_0\"> GCP VM 兩台變四台</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_1\" checked=\"true\" disabled=\"true\" /><label for=\"cbx_1\"> 設定測試站 subdomain</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_2\" checked=\"true\" disabled=\"true\" /><label for=\"cbx_2\"> GitHub 設定 main/test 兩個分支</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_3\" checked=\"true\" disabled=\"true\" /><label for=\"cbx_3\"> GitHub Action 設定只有 test 分支 push 時才自動更新到測試站</label></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"cbx_4\" disabled=\"true\" /><label for=\"cbx_4\"> 你升職，我加薪，大家開香檳～ＹＡ</label></li>\n</ul>\n<p><img loading=\"lazy\" src=\"Love-on-Delivery.gif\" alt=\"破壞之王\" /></p>\n",
            "tags": [
                "Need to Know",
                "Story"
            ]
        },
        {
            "id": "https://8loser.github.io/2023/02/11/redis-cluster/",
            "url": "https://8loser.github.io/2023/02/11/redis-cluster/",
            "title": "GKE 佈署 Redis 叢集",
            "date_published": "2023-02-11T10:07:24.000Z",
            "content_html": "<h1 id=\"環境\"><a class=\"anchor\" href=\"#環境\">#</a> 環境</h1>\n<p>在 <a href=\"https://cloud.google.com/kubernetes-engine?hl=zh-tw\">Google Kubernetes Engine (GKE)</a> 內建置 Redis 叢集</p>\n<ul>\n<li>GKE node: g1-small * 2 (version 1.24.8-gke.2000)</li>\n<li>Redis 7</li>\n</ul>\n<h1 id=\"建立-configmap\"><a class=\"anchor\" href=\"#建立-configmap\">#</a> 建立 ConfigMap</h1>\n<p>建立給 redis 節點使用的共用設定檔，名稱為  <code>redis-cluster</code> ，之後建立為 volume 讓每個容器使用</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"><span>ConfigMap</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ConfigMap</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> redis<span class=\"token punctuation\">-</span>cluster</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token key atrule\">update-node.sh</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\"></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    #!/bin/sh</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    REDIS_NODES=\"/data/nodes.conf\"</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    sed -i -e \"/myself/ s/[0-9]\\&#123;1,3\\&#125;\\.[0-9]\\&#123;1,3\\&#125;\\.[0-9]\\&#123;1,3\\&#125;\\.[0-9]\\&#123;1,3\\&#125;/$&#123;POD_IP&#125;/\" $&#123;REDIS_NODES&#125;</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    exec \"$@\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token key atrule\">redis.conf</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span>+</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    cluster<span class=\"token punctuation\">-</span>enabled yes</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    cluster<span class=\"token punctuation\">-</span>require<span class=\"token punctuation\">-</span>full<span class=\"token punctuation\">-</span>coverage no</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    cluster<span class=\"token punctuation\">-</span>node<span class=\"token punctuation\">-</span>timeout 15000</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    cluster<span class=\"token punctuation\">-</span>config<span class=\"token punctuation\">-</span>file /data/nodes.conf</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    cluster<span class=\"token punctuation\">-</span>migration<span class=\"token punctuation\">-</span>barrier 1</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    appendonly yes</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    protected<span class=\"token punctuation\">-</span>mode no</pre></td></tr></table></figure><p>建立成功後可以在 GKE 界面的  <code>Secret與ConfigMap</code>  內看到新增的  <code>redis-cluster</code></p>\n<p><img loading=\"lazy\" src=\"gke-configmap.png\" alt=\"ConfigMap\" /></p>\n<h1 id=\"建立-statefulset\"><a class=\"anchor\" href=\"#建立-statefulset\">#</a> 建立 StatefulSet</h1>\n<ul>\n<li>StatefulSet 需要使用 Kubernetes v1.9 或之後的版本才支援</li>\n<li>.spec.selector.matchLabels 要跟 .spec.template.metadata.labels 相同</li>\n<li>.spec.replicas 至少要 6 個，redis cluster 至少要 6 個節點；3 個 master, 3 個 slave, 不過還沒查到為什麼。</li>\n</ul>\n<p>參考文章在 .spec.selector.template.spec.containers.volumes.defaultMode 是寫  <code>0755</code>  (八進位)，但是我在 Lens 內執行時會出現下面錯誤，所以改成十進位的  <code>493</code></p>\n<div class=\"note warning\">\n<p>create Pod redis-cluster-0 in StatefulSet redis-cluster failed error: Pod &quot;redis-cluster-0&quot; is invalid: [spec.volumes[1].configMap.defaultMode: Invalid value: 755: must be a number between 0 and 0777 (octal), both inclusive, spec.containers[0].volumeMounts[0].name: Not found: &quot;conf&quot;]</p>\n</div>\n<p>完整 yaml</p>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"><span>StatefulSet</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> StatefulSet</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> redis<span class=\"token punctuation\">-</span>cluster</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token key atrule\">serviceName</span><span class=\"token punctuation\">:</span> redis<span class=\"token punctuation\">-</span>cluster</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">6</span> <span class=\"token comment\"># by default is 1</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> redis<span class=\"token punctuation\">-</span>cluster <span class=\"token comment\"># has to match .spec.template.metadata.labels</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> redis<span class=\"token punctuation\">-</span>cluster <span class=\"token comment\"># has to match .spec.selector.matchLabels</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> redis</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> redis<span class=\"token punctuation\">:</span><span class=\"token number\">7</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">6379</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> client</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">containerPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">16379</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> gossip</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"/conf/update-node.sh\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"redis-server\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/conf/redis.conf\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> POD_IP</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          <span class=\"token key atrule\">valueFrom</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            <span class=\"token key atrule\">fieldRef</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>              <span class=\"token key atrule\">fieldPath</span><span class=\"token punctuation\">:</span> status.podIP</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> conf</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /conf</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          <span class=\"token key atrule\">readOnly</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> data</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /data</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          <span class=\"token key atrule\">readOnly</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> conf</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token key atrule\">configMap</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> redis<span class=\"token punctuation\">-</span>cluster</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          <span class=\"token comment\"># defaultMode: 0755</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          <span class=\"token key atrule\">defaultMode</span><span class=\"token punctuation\">:</span> <span class=\"token number\">493</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  <span class=\"token key atrule\">volumeClaimTemplates</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> data</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      <span class=\"token key atrule\">accessModes</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"ReadWriteOnce\"</span> <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          <span class=\"token key atrule\">storage</span><span class=\"token punctuation\">:</span> 1Gi</pre></td></tr></table></figure><p>執行完等一下<br />\n<img loading=\"lazy\" src=\"Let_the_Bullets_Fly.png\" alt=\"讓子彈飛一會兒\" /></p>\n<p>之後可以在 GKE 的  <code>工作負載</code>  內看到 6 個 Pod 建立完成<br />\n<img loading=\"lazy\" src=\"gke-stateful.png\" alt=\"Pods\" /></p>\n<p><code>儲存空間</code>  也會產生 6 個 PVC (PersistentVolumeClaim)<br />\n<img loading=\"lazy\" src=\"gke-pvc.png\" alt=\"PVC\" /></p>\n<p>或者使用指令查看</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"><span>kubectl get pods</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ kubectl get pods</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME              READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>redis-cluster-0   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8m31s</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>redis-cluster-1   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8m19s</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>redis-cluster-2   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8m7s</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>redis-cluster-3   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          7m56s</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>redis-cluster-4   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          7m39s</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>redis-cluster-5   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          7m28s</pre></td></tr></table></figure><figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"><span>kubectl get pv</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ kubectl get <span class=\"token function\">pv</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                          STORAGECLASS   REASON   AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pvc-01fc7eb6-e99a-4111-8923-53229eb112b4   1Gi        RWO            Delete           Bound    default/data-redis-cluster-1   standard-rwo            21m</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>pvc-4bc387e4-dd4c-4400-b99a-e75a720e509b   1Gi        RWO            Delete           Bound    default/data-redis-cluster-2   standard-rwo            21m</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>pvc-af768f00-7889-4fa5-9ef8-cb95337ef38a   1Gi        RWO            Delete           Bound    default/data-redis-cluster-5   standard-rwo            20m</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>pvc-b6dadea9-b10e-42cb-8ae4-729b186e8b7c   1Gi        RWO            Delete           Bound    default/data-redis-cluster-0   standard-rwo            21m</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>pvc-c42ebfa4-a726-42f5-b146-18c28de544a4   1Gi        RWO            Delete           Bound    default/data-redis-cluster-4   standard-rwo            20m</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>pvc-d1d4de96-2f91-4050-9707-8fd802bd7fb4   1Gi        RWO            Delete           Bound    default/data-redis-cluster-3   standard-rwo            21m</pre></td></tr></table></figure><h1 id=\"建立-service\"><a class=\"anchor\" href=\"#建立-service\">#</a> 建立 Service</h1>\n<figure class=\"highlight yaml\"><figcaption data-lang=\"YAML\"><span>Service</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Service</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> redis<span class=\"token punctuation\">-</span>cluster</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">6379</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">6379</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> client</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">16379</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token key atrule\">targetPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">16379</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> gossip</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> redis<span class=\"token punctuation\">-</span>cluster</pre></td></tr></table></figure><p>執行完檢查 Service  <code>redis-cluster</code>  是否成功建立<br />\n<img loading=\"lazy\" src=\"gke-service.png\" alt=\"service\" /></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"><span>kubectl get service redis-cluster</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ kubectl get <span class=\"token function\">service</span> redis-cluster</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME            TYPE        CLUSTER-IP    EXTERNAL-IP   PORT<span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span>              AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>redis-cluster   ClusterIP   <span class=\"token number\">10.80</span>.5.184   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">6379</span>/TCP,16379/TCP   2m50s</pre></td></tr></table></figure><h1 id=\"建立-redis-叢集\"><a class=\"anchor\" href=\"#建立-redis-叢集\">#</a> 建立 Redis 叢集</h1>\n<p>參考的文章使用的指令如下</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"><span>create redis-cluster</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> redis-cluster-0 -- redis-cli <span class=\"token parameter variable\">--cluster</span> create --cluster-replicas <span class=\"token number\">1</span> <span class=\"token variable\"><span class=\"token variable\">$(</span>kubectl get pods <span class=\"token parameter variable\">-l</span> <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>redis-cluster <span class=\"token parameter variable\">-o</span> <span class=\"token assign-left variable\">jsonpath</span><span class=\"token operator\">=</span><span class=\"token string\">'&#123;range.items[*]&#125;&#123;.status.podIP&#125;:6379 '</span><span class=\"token variable\">)</span></span></pre></td></tr></table></figure><p>實際實行結果會出現如下錯誤</p>\n<div class=\"note danger\">\n<p>kubectl exec -it redis-cluster-0 -- redis-cli --cluster create --cluster-replicas 1 $(kubectl get pods -l app=redis-cluster -o jsonpath='{range.items[*]}{.status.podIP}:6379 ')</p>\n</div>\n<p>查看原因是  <code>kubectl get pods -l app=redis-cluster -o jsonpath='&#123;range.items[*]&#125;&#123;.status.podIP&#125;</code>  會多一組空的 IP</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ kubectl get pods <span class=\"token parameter variable\">-l</span> <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>redis-cluster <span class=\"token parameter variable\">-o</span> <span class=\"token assign-left variable\">jsonpath</span><span class=\"token operator\">=</span><span class=\"token string\">'&#123;range.items[*]&#125;&#123;.status.podIP&#125;:6379 '</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">10.76</span>.2.30:6379 <span class=\"token number\">10.76</span>.1.32:6379 <span class=\"token number\">10.76</span>.2.31:6379 <span class=\"token number\">10.76</span>.1.33:6379 <span class=\"token number\">10.76</span>.2.32:6379 <span class=\"token number\">10.76</span>.1.34:6379 :6379</pre></td></tr></table></figure><p>可以使用下面指令查看比較明顯</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ kubectl get pods <span class=\"token parameter variable\">-l</span> <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>redis-cluster <span class=\"token parameter variable\">-o</span> <span class=\"token assign-left variable\">jsonpath</span><span class=\"token operator\">=</span><span class=\"token string\">'&#123;range.items[*]&#125;&#123;.status.podIP&#125;:6379&#123;\"\\n\"&#125;'</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">10.76</span>.2.30:6379</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">10.76</span>.1.32:6379</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">10.76</span>.2.31:6379</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">10.76</span>.1.33:6379</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">10.76</span>.2.32:6379</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">10.76</span>.1.34:6379</pre></td></tr><tr class=\"marked\"><td data-num=\"8\"></td><td><pre>:6379</pre></td></tr></table></figure><p>修改後指令如下</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> redis-cluster-0 -- redis-cli <span class=\"token parameter variable\">--cluster</span> create --cluster-replicas <span class=\"token number\">1</span> <span class=\"token variable\"><span class=\"token variable\">$(</span>kubectl get pods <span class=\"token parameter variable\">-o</span><span class=\"token operator\">=</span>jsonpath<span class=\"token operator\">=</span><span class=\"token string\">'&#123;range .items[*]&#125;&#123;.status.podIP&#125;:6379 &#123;end&#125;'</span><span class=\"token variable\">)</span></span></pre></td></tr></table></figure><p><code>Can I set the above configuration?</code>  輸入  <code>yes</code> ，執行結果可以看到建立了 3 個 redis master 節點，3 個 slave 節點。</p>\n<details class=\"info\"><summary>執行結果</summary><div>\n<p>$ kubectl exec -it redis-cluster-0 -- redis-cli --cluster create --cluster-replicas 1 $(kubectl get pods -o=jsonpath='{range .items[*]}{.status.podIP}:6379 {end}')<br />\n&gt;&gt;&gt; Performing hash slots allocation on 6 nodes...<br />\nMaster[0] -&gt; Slots 0 - 5460<br />\nMaster[1] -&gt; Slots 5461 - 10922<br />\nMaster[2] -&gt; Slots 10923 - 16383<br />\nAdding replica 10.76.2.32:6379 to 10.76.2.30:6379<br />\nAdding replica 10.76.1.34:6379 to 10.76.1.32:6379<br />\nAdding replica 10.76.1.33:6379 to 10.76.2.31:6379<br />\nM: 05ecf3912ed0a5517ab74fd17f81d02a3314a833 10.76.2.30:6379<br />\nslots:[0-5460] (5461 slots) master<br />\nM: 9da23852cfd0a7489c2f53ec743363e48dea378b 10.76.1.32:6379<br />\nslots:[5461-10922] (5462 slots) master<br />\nM: 379127b6974b6acc59e5fb194361749e682bdc97 10.76.2.31:6379<br />\nslots:[10923-16383] (5461 slots) master<br />\nS: 5105cdd3a6637e3844316c557f81c68b231703e7 10.76.1.33:6379<br />\nreplicates 379127b6974b6acc59e5fb194361749e682bdc97<br />\nS: dde0a9ef27e044cd124814529305732c9ab0d9dd 10.76.2.32:6379<br />\nreplicates 05ecf3912ed0a5517ab74fd17f81d02a3314a833<br />\nS: 8a89a45f3161b606b13f1ede95fec240de2bcf9d 10.76.1.34:6379<br />\nreplicates 9da23852cfd0a7489c2f53ec743363e48dea378b<br />\nCan I set the above configuration? (type 'yes' to accept): yes<br />\n&gt;&gt;&gt; Nodes configuration updated<br />\n&gt;&gt;&gt; Assign a different config epoch to each node<br />\n&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster<br />\nWaiting for the cluster to join</p>\n<p>&gt;&gt;&gt; Performing Cluster Check (using node 10.76.2.30:6379)<br />\nM: 05ecf3912ed0a5517ab74fd17f81d02a3314a833 10.76.2.30:6379<br />\nslots:[0-5460] (5461 slots) master<br />\n1 additional replica(s)<br />\nS: dde0a9ef27e044cd124814529305732c9ab0d9dd 10.76.2.32:6379<br />\nslots: (0 slots) slave<br />\nreplicates 05ecf3912ed0a5517ab74fd17f81d02a3314a833<br />\nS: 5105cdd3a6637e3844316c557f81c68b231703e7 10.76.1.33:6379<br />\nslots: (0 slots) slave<br />\nreplicates 379127b6974b6acc59e5fb194361749e682bdc97<br />\nM: 379127b6974b6acc59e5fb194361749e682bdc97 10.76.2.31:6379<br />\nslots:[10923-16383] (5461 slots) master<br />\n1 additional replica(s)<br />\nM: 9da23852cfd0a7489c2f53ec743363e48dea378b 10.76.1.32:6379<br />\nslots:[5461-10922] (5462 slots) master<br />\n1 additional replica(s)<br />\nS: 8a89a45f3161b606b13f1ede95fec240de2bcf9d 10.76.1.34:6379<br />\nslots: (0 slots) slave<br />\nreplicates 9da23852cfd0a7489c2f53ec743363e48dea378b<br />\n[OK] All nodes agree about slots configuration.<br />\n&gt;&gt;&gt; Check for open slots...<br />\n&gt;&gt;&gt; Check slots coverage...<br />\n[OK] All 16384 slots covered.</p>\n</div></details>\n<h1 id=\"驗證-redis-叢集\"><a class=\"anchor\" href=\"#驗證-redis-叢集\">#</a> 驗證 Redis 叢集</h1>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> redis-cluster-0 -- redis-cli cluster info</pre></td></tr></table></figure><details class=\"info\"><summary>執行結果</summary><div>\n<p>$ kubectl exec -it redis-cluster-0 -- redis-cli cluster info<br />\ncluster_state:ok<br />\ncluster_slots_assigned:16384<br />\ncluster_slots_ok:16384<br />\ncluster_slots_pfail:0<br />\ncluster_slots_fail:0<br />\ncluster_known_nodes:6<br />\ncluster_size:3<br />\ncluster_current_epoch:6<br />\ncluster_my_epoch:1<br />\ncluster_stats_messages_ping_sent:273<br />\ncluster_stats_messages_pong_sent:278<br />\ncluster_stats_messages_sent:551<br />\ncluster_stats_messages_ping_received:273<br />\ncluster_stats_messages_pong_received:273<br />\ncluster_stats_messages_meet_received:5<br />\ncluster_stats_messages_received:551<br />\ntotal_cluster_links_buffer_limit_exceeded:0</p>\n</div></details>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">x</span> <span class=\"token keyword\">in</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">seq</span> <span class=\"token number\">0</span> <span class=\"token number\">5</span><span class=\"token variable\">)</span></span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span> <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"redis-cluster-<span class=\"token variable\">$x</span>\"</span><span class=\"token punctuation\">;</span> kubectl <span class=\"token builtin class-name\">exec</span> redis-cluster-<span class=\"token variable\">$x</span> -- redis-cli role<span class=\"token punctuation\">;</span> <span class=\"token builtin class-name\">echo</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">done</span></pre></td></tr></table></figure><details class=\"info\"><summary>執行結果</summary><div>\n<p>$ for x in <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo stretchy=\"false\">(</mo><mi>s</mi><mi>e</mi><mi>q</mi><mn>05</mn><mo stretchy=\"false\">)</mo><mo separator=\"true\">;</mo><mi>d</mi><mi>o</mi><mi>e</mi><mi>c</mi><mi>h</mi><mi>o</mi><mi mathvariant=\"normal\">&quot;</mi><mi>r</mi><mi>e</mi><mi>d</mi><mi>i</mi><mi>s</mi><mo>−</mo><mi>c</mi><mi>l</mi><mi>u</mi><mi>s</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>−</mo></mrow><annotation encoding=\"application/x-tex\">(seq 0 5); do echo &quot;redis-cluster-</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">se</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span><span class=\"mord\">05</span><span class=\"mclose\">)</span><span class=\"mpunct\">;</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">oec</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">o</span><span class=\"mord\">&quot;</span><span class=\"mord mathnormal\">re</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7778em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">er</span><span class=\"mord\">−</span></span></span></span>x&quot;; kubectl exec redis-cluster-$x -- redis-cli role; echo; done<br />\nredis-cluster-0<br />\nmaster<br />\n504<br />\n10.76.2.32<br />\n6379<br />\n504</p>\n<p>redis-cluster-1<br />\nmaster<br />\n504<br />\n10.76.1.34<br />\n6379<br />\n504</p>\n<p>redis-cluster-2<br />\nmaster<br />\n490<br />\n10.76.1.33<br />\n6379<br />\n490</p>\n<p>redis-cluster-3<br />\nslave<br />\n10.76.2.31<br />\n6379<br />\nconnected<br />\n490</p>\n<p>redis-cluster-4<br />\nslave<br />\n10.76.2.30<br />\n6379<br />\nconnected<br />\n504</p>\n<p>redis-cluster-5<br />\nslave<br />\n10.76.1.32<br />\n6379<br />\nconnected<br />\n504</p>\n</div></details>\n<h1 id=\"yaml-檔案\"><a class=\"anchor\" href=\"#yaml-檔案\">#</a> YAML 檔案</h1>\n<p><a href=\"https://github.com/8loser/redis-sts\">GitHub: 8loser/redis-sts</a></p>\n<h1 id=\"參考\"><a class=\"anchor\" href=\"#參考\">#</a> 參考</h1>\n<p><a href=\"https://www.suse.com/c/rancher_blog/deploying-redis-cluster-on-top-of-kubernetes/\">Deploying Redis Cluster on Top of Kubernetes February 22, 2019 | By: Rancher Admin</a></p>\n",
            "tags": [
                "Redis",
                "GKE",
                "Kubernetes"
            ]
        },
        {
            "id": "https://8loser.github.io/2023/01/04/gcp-init/",
            "url": "https://8loser.github.io/2023/01/04/gcp-init/",
            "title": "GCP VM 初始化",
            "date_published": "2023-01-04T07:32:51.000Z",
            "content_html": "<h1 id=\"主旨\"><a class=\"anchor\" href=\"#主旨\">#</a> 主旨</h1>\n<p>把專案運行的 GCP VM 環境佈署動作整理，建立 shell script 進行快速佈署。使用作業系統為 Linux Ubuntu</p>\n<h1 id=\"執行之前\"><a class=\"anchor\" href=\"#執行之前\">#</a> 執行之前</h1>\n<p>先執行下面指令，切換為 root 角色</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">su</span> -</pre></td></tr></table></figure><h1 id=\"要新增的-linux-帳號\"><a class=\"anchor\" href=\"#要新增的-linux-帳號\">#</a> 要新增的 Linux 帳號</h1>\n<p>把要新增的帳號、密碼作為變數寫在 script 最上面，為了給共同維護的人登入用的。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token assign-left variable\">ACCOUNT</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>帳號<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token assign-left variable\">PASSWORD</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>密碼<span class=\"token operator\">></span></pre></td></tr></table></figure><h1 id=\"github-帳號\"><a class=\"anchor\" href=\"#github-帳號\">#</a> GitHub 帳號</h1>\n<p>執行環境會把 docker image 從 GitHub registry 抓下來執行，所以在 script 最上面把 GitHub 權限設定為變數，之後執行讀取變數即可。密碼為 PAT（personal access token），建立方法請參考 <a href=\"https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token\">建立 PAT</a>。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token assign-left variable\">GITHUB_ACCOUNT</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>github帳號<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token assign-left variable\">GITHUB_PAT</span><span class=\"token operator\">=</span><span class=\"token operator\">&lt;</span>github PAT<span class=\"token operator\">></span></pre></td></tr></table></figure><h1 id=\"設定時區\"><a class=\"anchor\" href=\"#設定時區\">#</a> 設定時區</h1>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>timedatectl set-timezone Asia/Taipei</pre></td></tr></table></figure><h1 id=\"作業系統更新\"><a class=\"anchor\" href=\"#作業系統更新\">#</a> 作業系統更新</h1>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">apt</span> update <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">apt</span> upgrade <span class=\"token parameter variable\">-y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">apt-get</span> clean <span class=\"token parameter variable\">-y</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">apt-get</span> autoremove <span class=\"token parameter variable\">-y</span></pre></td></tr></table></figure><h1 id=\"啟用-google-bbr\"><a class=\"anchor\" href=\"#啟用-google-bbr\">#</a> 啟用 Google BBR</h1>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>modprobe tcp_bbr</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"tcp_bbr\"</span> <span class=\"token operator\">>></span> /etc/modules-load.d/modules.conf</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"net.core.default_qdisc=fq\"</span> <span class=\"token operator\">>></span> /etc/sysctl.conf</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"net.ipv4.tcp_congestion_control=bbr\"</span> <span class=\"token operator\">>></span> /etc/sysctl.conf</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">sysctl</span> <span class=\"token parameter variable\">-p</span></pre></td></tr></table></figure><h1 id=\"install-ops-agent\"><a class=\"anchor\" href=\"#install-ops-agent\">#</a> Install Ops Agent</h1>\n<p>安裝 <a href=\"https://cloud.google.com/stackdriver/docs/solutions/agents/ops-agent\">GCP agent</a>，如果不是使用 GCP 可以不用執行</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-sSO</span> https://dl.google.com/cloudagents/add-google-cloud-ops-agent-repo.sh</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">bash</span> add-google-cloud-ops-agent-repo.sh --also-install</pre></td></tr></table></figure><h1 id=\"安裝-docker\"><a class=\"anchor\" href=\"#安裝-docker\">#</a> 安裝 Docker</h1>\n<p>所有專案都以 container 形式使用 docker compose 運行。安裝 docker 沒毛病。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">apt-get</span> update</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> ca-certificates <span class=\"token function\">curl</span> gnupg lsb-release <span class=\"token parameter variable\">-y</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /etc/apt/keyrings</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg <span class=\"token operator\">|</span> <span class=\"token function\">sudo</span> gpg <span class=\"token parameter variable\">--dearmor</span> <span class=\"token parameter variable\">-o</span> /etc/apt/keyrings/docker.gpg</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token string\">\"deb [arch=<span class=\"token variable\"><span class=\"token variable\">$(</span>dpkg --print-architecture<span class=\"token variable\">)</span></span> signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \\</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token variable\"><span class=\"token variable\">$(</span>lsb_release <span class=\"token parameter variable\">-cs</span><span class=\"token variable\">)</span></span> stable\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> /etc/apt/sources.list.d/docker.list <span class=\"token operator\">></span> /dev/null</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">apt-get</span> update</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> docker-ce docker-ce-cli containerd.io docker-compose-plugin <span class=\"token parameter variable\">-y</span> <span class=\"token parameter variable\">-q</span></pre></td></tr></table></figure><h1 id=\"安裝-portainer-with-docker-swarm\"><a class=\"anchor\" href=\"#安裝-portainer-with-docker-swarm\">#</a> 安裝 Portainer with Docker Swarm</h1>\n<p>使用 portainer 管理 container，portainer 很棒，是 web 界面。加上 docker swarm 是為了讓程式上傳後可以通知 server 去 pull 新的 image 自動佈署。 <code>一言不合就 CI/CD</code></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> volume create portainer_data</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">-p</span> <span class=\"token number\">8000</span>:8000 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">9443</span>:9443 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">9000</span>:9000 <span class=\"token parameter variable\">--name</span> portainer <span class=\"token parameter variable\">--restart</span><span class=\"token operator\">=</span>always <span class=\"token parameter variable\">-v</span> /var/run/docker.sock:/var/run/docker.sock <span class=\"token parameter variable\">-v</span> portainer_data:/data portainer/portainer-ce:latest</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">docker</span> swarm init</pre></td></tr></table></figure><h1 id=\"建立-crond-docker-prune\"><a class=\"anchor\" href=\"#建立-crond-docker-prune\">#</a> 建立 crond docker-prune</h1>\n<p>每天自動清理 docker 垃圾，每次更新產生沒用的 image、cointainer 太多會造成主機容量不足掛掉。<br />\n<s>不然每次掛掉老闆都罵我，我也不知道為什麼有人一天要 commit 600 次</s></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> <span class=\"token operator\">>></span> /etc/cron.daily/docker-prune <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">EOL</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>#!/bin/bash</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>docker system prune -af</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>EOL</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">chmod</span> ugo+x /etc/cron.daily/docker-prune</pre></td></tr></table></figure><h1 id=\"建立-linux-帳號\"><a class=\"anchor\" href=\"#建立-linux-帳號\">#</a> 建立 Linux 帳號</h1>\n<p>使用最上面設定的變數建立帳號，讓其他維護的同學登入。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">useradd</span> <span class=\"token parameter variable\">-c</span> <span class=\"token string\">\"update user\"</span> <span class=\"token parameter variable\">-s</span> /bin/bash <span class=\"token parameter variable\">-G</span> <span class=\"token function\">sudo</span> <span class=\"token parameter variable\">-m</span> <span class=\"token variable\">$ACCOUNT</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$ACCOUNT</span>:<span class=\"token variable\">$PASSWORD</span>\"</span> <span class=\"token operator\">|</span> chpasswd</pre></td></tr></table></figure><h1 id=\"登入-docker-registry\"><a class=\"anchor\" href=\"#登入-docker-registry\">#</a> 登入 Docker registry</h1>\n<p>登入 GitHub registry 之後 docker pull 就不用輸入密碼，讚！</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token variable\">$GITHUB_PAT</span> <span class=\"token operator\">|</span> <span class=\"token function\">docker</span> login ghcr.io <span class=\"token parameter variable\">--username</span> <span class=\"token variable\">$GITHUB_ACCOUNT</span> --password-stdin</pre></td></tr></table></figure><h1 id=\"完整-shell-script\"><a class=\"anchor\" href=\"#完整-shell-script\">#</a> 完整 shell script</h1>\n<ul>\n<li><a href=\"https://gist.github.com/8loser/f54b673b93a2df296887c2bd6edf96e8\">https://gist.github.com/8loser/f54b673b93a2df296887c2bd6edf96e8</a></li>\n</ul>\n",
            "tags": [
                "Linux",
                "Shell script",
                "GCP"
            ]
        },
        {
            "id": "https://8loser.github.io/2022/10/21/nginx-websocket/",
            "url": "https://8loser.github.io/2022/10/21/nginx-websocket/",
            "title": "Nginx websocket 無法連接",
            "date_published": "2022-10-21T09:10:38.000Z",
            "content_html": "<h1 id=\"環境\"><a class=\"anchor\" href=\"#環境\">#</a> 環境</h1>\n<p>在 docker compose 中，使用 nginx 導向 websocket 到 container 內</p>\n<h1 id=\"錯誤訊息\"><a class=\"anchor\" href=\"#錯誤訊息\">#</a> 錯誤訊息</h1>\n<p>websocket 連接不上，查看 request headers 顯示  <code>Provisional headers are shown</code></p>\n<p><img loading=\"lazy\" src=\"provisional_headers_are_shown.png\" alt=\"provisional headers are shown\" /></p>\n<h1 id=\"solution\"><a class=\"anchor\" href=\"#solution\">#</a> Solution</h1>\n<p>搜尋解決方法是在 nginx.conf 內加上</p>\n<figure class=\"highlight editorconfig\"><figcaption data-lang=\"editorconfig\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>proxy_set_header Upgrade $http_upgrade<span class=\"token comment\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>proxy_set_header Connection \"upgrade\"<span class=\"token comment\">;</span></pre></td></tr></table></figure><h2 id=\"範例\"><a class=\"anchor\" href=\"#範例\">#</a> 範例</h2>\n<figure class=\"highlight editorconfig\"><figcaption data-lang=\"editorconfig\"><span>範例</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre>location /backend/ &#123;</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    proxy_pass http://backend/<span class=\"token comment\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    proxy_set_header Host $host<span class=\"token comment\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    proxy_set_header X-Real-IP $remote_addr<span class=\"token comment\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for<span class=\"token comment\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    proxy_set_header X-Custom-Referrer smc_identity_layer<span class=\"token comment\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\"># websocket 要加下面兩個</span></pre></td></tr><tr class=\"marked\"><td data-num=\"8\"></td><td><pre>    proxy_set_header Upgrade $http_upgrade<span class=\"token comment\">;</span></pre></td></tr><tr class=\"marked\"><td data-num=\"9\"></td><td><pre>    proxy_set_header Connection \"upgrade\"<span class=\"token comment\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>&#125;</pre></td></tr></table></figure><h1 id=\"驗證\"><a class=\"anchor\" href=\"#驗證\">#</a> 驗證</h1>\n<p>比較有修正前跟修正後，後端實際收到的 request header</p>\n<h2 id=\"修正前-request-headers\"><a class=\"anchor\" href=\"#修正前-request-headers\">#</a> 修正前 request headers</h2>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"><span>修正前</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">Headers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token string-property property\">'host'</span><span class=\"token operator\">:</span> <span class=\"token string\">'localhost'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token string-property property\">'x-real-ip'</span><span class=\"token operator\">:</span> <span class=\"token string\">'192.168.224.1'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token string-property property\">'x-forwarded-for'</span><span class=\"token operator\">:</span> <span class=\"token string\">'192.168.224.1'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> <span class=\"token string-property property\">'x-custom-referrer'</span><span class=\"token operator\">:</span> <span class=\"token string\">'smc_identity_layer'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr class=\"marked\"><td data-num=\"5\"></td><td><pre> <span class=\"token string-property property\">'connection'</span><span class=\"token operator\">:</span> <span class=\"token string\">'close'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> <span class=\"token string-property property\">'pragma'</span><span class=\"token operator\">:</span> <span class=\"token string\">'no-cache'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token string-property property\">'cache-control'</span><span class=\"token operator\">:</span> <span class=\"token string\">'no-cache'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token string-property property\">'user-agent'</span><span class=\"token operator\">:</span> <span class=\"token string\">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/106.0.0.0 Safari/537.36'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre> <span class=\"token string-property property\">'origin'</span><span class=\"token operator\">:</span> <span class=\"token string\">'chrome-extension://cbcbkhdmedgianpaifchdaddpnmgnknn'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token string-property property\">'sec-websocket-version'</span><span class=\"token operator\">:</span> <span class=\"token string\">'13'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token string-property property\">'accept-encoding'</span><span class=\"token operator\">:</span> <span class=\"token string\">'gzip, deflate, br'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> <span class=\"token string-property property\">'accept-language'</span><span class=\"token operator\">:</span> <span class=\"token string\">'zh-TW,zh;q=0.9,en-US;q=0.8,en;q=0.7'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> <span class=\"token string-property property\">'sec-websocket-key'</span><span class=\"token operator\">:</span> <span class=\"token string\">'iBVj1v1X8xkD324lsXZSUA=='</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre> <span class=\"token string-property property\">'sec-websocket-extensions'</span><span class=\"token operator\">:</span> <span class=\"token string\">'permessage-deflate; client_max_window_bits'</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h2 id=\"修正後-request-headers\"><a class=\"anchor\" href=\"#修正後-request-headers\">#</a> 修正後 request headers</h2>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"><span>修正後</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">Headers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span><span class=\"token string-property property\">'host'</span><span class=\"token operator\">:</span> <span class=\"token string\">'localhost'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token string-property property\">'x-real-ip'</span><span class=\"token operator\">:</span> <span class=\"token string\">'192.168.208.1'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token string-property property\">'x-forwarded-for'</span><span class=\"token operator\">:</span> <span class=\"token string\">'192.168.208.1'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token string-property property\">'x-custom-referrer'</span><span class=\"token operator\">:</span> <span class=\"token string\">'smc_identity_layer'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr class=\"marked\"><td data-num=\"5\"></td><td><pre><span class=\"token string-property property\">'upgrade'</span><span class=\"token operator\">:</span> <span class=\"token string\">'websocket'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr class=\"marked\"><td data-num=\"6\"></td><td><pre><span class=\"token string-property property\">'connection'</span><span class=\"token operator\">:</span> <span class=\"token string\">'upgrade'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token string-property property\">'pragma'</span><span class=\"token operator\">:</span> <span class=\"token string\">'no-cache'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token string-property property\">'cache-control'</span><span class=\"token operator\">:</span> <span class=\"token string\">'no-cache'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token string-property property\">'user-agent'</span><span class=\"token operator\">:</span> <span class=\"token string\">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/106.0.0.0 Safari/537.36'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token string-property property\">'origin'</span><span class=\"token operator\">:</span> <span class=\"token string\">'chrome-extension://cbcbkhdmedgianpaifchdaddpnmgnknn'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token string-property property\">'sec-websocket-version'</span><span class=\"token operator\">:</span> <span class=\"token string\">'13'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token string-property property\">'accept-encoding'</span><span class=\"token operator\">:</span> <span class=\"token string\">'gzip, deflate, br'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token string-property property\">'accept-language'</span><span class=\"token operator\">:</span> <span class=\"token string\">'zh-TW,zh;q=0.9,en-US;q=0.8,en;q=0.7'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token string-property property\">'sec-websocket-key'</span><span class=\"token operator\">:</span> <span class=\"token string\">'j2NwT86WmJt6rIyatTa5rw=='</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token string-property property\">'sec-websocket-extensions'</span><span class=\"token operator\">:</span> <span class=\"token string\">'permessage-deflate; client_max_window_bits'</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure>",
            "tags": [
                "Trouble",
                "Nginx",
                "WebSocket"
            ]
        },
        {
            "id": "https://8loser.github.io/2022/07/23/docker-access-host/",
            "url": "https://8loser.github.io/2022/07/23/docker-access-host/",
            "title": "Docker Container 存取 host 服務",
            "date_published": "2022-07-23T07:47:36.000Z",
            "content_html": "<h1 id=\"docker-container-存取-host-服務\"><a class=\"anchor\" href=\"#docker-container-存取-host-服務\">#</a> Docker Container 存取 host 服務</h1>\n<p>場景應用如 container 運行程式，host 安裝資料庫。container 內的程式需要存取安裝在 host 的資料庫。</p>\n<p>只要在程式內呼叫資料庫的位址使用  <code>host.docker.internal</code>  即可，如在 host 安裝 PostgreSQL，程式內設定資料庫位置就是</p>\n<blockquote>\n<p><code>host.docker.internal:5432</code></p>\n</blockquote>\n<p>原本還有下面兩個，不過已經 deprecated 了。</p>\n<blockquote>\n<p><code>docker.for.mac.host.internal</code></p>\n</blockquote>\n<blockquote>\n<p><code>docker.for.mac.localhost</code></p>\n</blockquote>\n<h1 id=\"參考資料\"><a class=\"anchor\" href=\"#參考資料\">#</a> 參考資料</h1>\n<p><div class=\"links\"><div class=\"item\" title=\"docker docs\" style=\"--block-color:#9d5b8b;\"><a href=\"https://docs.docker.com/desktop/networking/#i-want-to-connect-from-a-container-to-a-service-on-the-host\" class=\"image\" data-background-image=\"/assets/404.png\"></a>\n        <div class=\"info\">\n        <a href=\"https://docs.docker.com/desktop/networking/#i-want-to-connect-from-a-container-to-a-service-on-the-host\" class=\"title\">docker docs</a>\n        <p class=\"desc\">I want to connect from a container to a service on the host</p>\n        </div></div></div></p>\n",
            "tags": [
                "Need to Know",
                "Docker"
            ]
        },
        {
            "id": "https://8loser.github.io/2022/06/26/git_of_devcontainer/",
            "url": "https://8loser.github.io/2022/06/26/git_of_devcontainer/",
            "title": "VSCode devcontainer 使用 git",
            "date_published": "2022-06-25T16:41:02.000Z",
            "content_html": "<h1 id=\"remote-container-使用-git\"><a class=\"anchor\" href=\"#remote-container-使用-git\">#</a> Remote container 使用 git</h1>\n<p>在 Visual Studio Code (下面使用 VSCode 稱呼) 內使用 devcontainer 開發時，怎麼使用 git?</p>\n<p>我的開發方式都是從 git hub 上 clone 程式後建立 devcontainer 環境進行開發</p>\n<p>當建立完 devcontainer 環境進入 container 後，點選 VSCode 左邊的 Source Control 項目時，會出現</p>\n<p><img loading=\"lazy\" src=\"source_control_no_git_repo.png\" alt=\"The folder currently open doesn't have a git repository\" /></p>\n<p>且右下角出現提示</p>\n<p><img loading=\"lazy\" src=\"git_not_found.png\" alt=\"Git not found. Install it or configure it using the 'git.path' setting\" /></p>\n<p>出現這種情況表示 container 內沒有安裝 git</p>\n<h1 id=\"安裝-git\"><a class=\"anchor\" href=\"#安裝-git\">#</a> 安裝 git</h1>\n<p>在 container 內安裝 git 的方法，可以在 Dockerfile 內加上</p>\n<figure class=\"highlight dockerfile\"><figcaption data-lang=\"Docker\"><span>Dockerfile</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">RUN</span> apk update &amp;&amp; apk upgrade &amp;&amp; apk add --no-cache <span class=\"token operator\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    git</span></pre></td></tr></table></figure><p>如果是使用  <code>apt-get</code>  (不過我沒有用 apt-get 測試過)</p>\n<figure class=\"highlight dockerfile\"><figcaption data-lang=\"Docker\"><span>Dockerfile</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">RUN</span> apt-get update &amp;&amp; apt-get install -y --no-install-recommends <span class=\"token operator\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    git <span class=\"token operator\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    &amp;&amp; rm -rf /var/lib/apt/lists/*</span></pre></td></tr></table></figure><h1 id=\"cafile-none\"><a class=\"anchor\" href=\"#cafile-none\">#</a> CAfile: none</h1>\n<p>如果在 container 內 git pull 時出現  <code>CAfile: none</code>  的訊息</p>\n<p><img loading=\"lazy\" src=\"CAfileNone.png\" alt=\"Git: fatal: server certificate verification failed. CAfile: none CRLfile: none\" /></p>\n<p>修改 Dockerfile，加上 ca-certificates 變成</p>\n<figure class=\"highlight dockerfile\"><figcaption data-lang=\"Docker\"><span>Dockerfile</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">RUN</span> apt-get update &amp;&amp; apt-get install -y --no-install-recommends <span class=\"token operator\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    git <span class=\"token operator\">\\</span></pre></td></tr><tr class=\"marked\"><td data-num=\"3\"></td><td><pre>    ca-certificates <span class=\"token operator\">\\</span></pre></td></tr><tr class=\"marked\"><td data-num=\"4\"></td><td><pre>    &amp;&amp; update-ca-certificates <span class=\"token operator\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    &amp;&amp; rm -rf /var/lib/apt/lists/*</span></pre></td></tr></table></figure><h1 id=\"so-many-pending-changes\"><a class=\"anchor\" href=\"#so-many-pending-changes\">#</a> So many pending changes</h1>\n<p>改完 Dockerfile 後執行 Rebuild container 再次進入 container 查看 Source Control</p>\n<p>可能會出現很多 change 的檔案</p>\n<p><img loading=\"lazy\" src=\"source_control_pending_changes.png\" alt=\"So Many Pending Changes\" /></p>\n<p>但實際上你並沒有修改這些檔案，查看 diff 也看沒看到有變更的地方</p>\n<h1 id=\"git-autocrlf\"><a class=\"anchor\" href=\"#git-autocrlf\">#</a> Git AutoCrLf</h1>\n<p>如果你跟我一樣是使用 Windows 安裝 docker 的話，很有可能會遇到這個狀況</p>\n<p>這是因為 Windows 跟 Linux 的跳行符號不一樣的關係</p>\n<div class=\"note info\">\n<p>DOS/Windows 跳行使用 CR/LF (\\r\\n)<br />\n UNIX/Linux 跳行使用 LF (\\n)</p>\n</div>\n<p>可以執行</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"><span>git config</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">git</span> config <span class=\"token parameter variable\">--global</span> core.autocrlf <span class=\"token boolean\">true</span></pre></td></tr></table></figure><p>然後在 Source Control refresh 就可以看到 change 的檔案變少了</p>\n<p>如果不想每次建立 devcontainer 環境都要執行一次的話，可以修改 Windows 的 git config</p>\n<p>使用 TortoiseGit 可以參考<br />\n<a href=\"https://tortoisegit.org/docs/tortoisegit/tgit-dug-settings.html#tgit-dug-settings-config\"> https://tortoisegit.org/docs/tortoisegit/tgit-dug-settings.html#tgit-dug-settings-config</a></p>\n<p>不建議在 Dockerfile 內使用 RUN 或者在 devcontainer.json 內設定 autocrlf</p>\n<p>因為原本  <code>user.name</code> ,  <code>user.email</code>  ... 相關資訊會不見，導致無法執行 push/pull 等動作</p>\n<p>如果要在 Dockerfile 內設定 autocrlf 可以用</p>\n<figure class=\"highlight dockerfile\"><figcaption data-lang=\"Docker\"><span>Dockerfile</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token instruction\"><span class=\"token keyword\">RUN</span> git config --global core.autocrlf true</span></pre></td></tr></table></figure><p>可以自己測試看看加跟不加時，進入 container 後 config 的差異</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"><span>list git config</span></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">git</span> config <span class=\"token parameter variable\">--global</span> <span class=\"token parameter variable\">-l</span></pre></td></tr></table></figure>",
            "tags": [
                "VSCode",
                "Remote Container",
                "Git"
            ]
        }
    ]
}